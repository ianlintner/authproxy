---
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: spc-oauth2-proxy
  namespace: default
  labels:
    app.kubernetes.io/name: oauth2-proxy
    app.kubernetes.io/component: secrets
spec:
  provider: azure
  parameters:
    # Azure Key Vault configuration shared with chat-backend
    keyvaultName: "ai-chat-kv-1763873634"
    tenantId: "42ddc44e-97dd-4c3b-bf8a-31c785e24c67"

    # Authentication (user-assigned managed identity already configured in cluster)
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: "e502213f-1f15-4f03-9fb4-b546f51aafe9"

    # Azure cloud
    cloudName: "AzurePublicCloud"

    # Objects to fetch from Key Vault
    objects: |
      array:
        - |
          objectName: oauth2-proxy-client-id
          objectType: secret
        - |
          objectName: oauth2-proxy-client-secret
          objectType: secret
        - |
          objectName: oauth2-proxy-cookie-secret
          objectType: secret

  # Sync to a Kubernetes Secret that the Deployment already references
  secretObjects:
  - secretName: oauth2-proxy-secret
    type: Opaque
    data:
    - objectName: oauth2-proxy-client-id
      key: client-id
    - objectName: oauth2-proxy-client-secret
      key: client-secret
    - objectName: oauth2-proxy-cookie-secret
      key: cookie-secret
