---
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: spc-oauth2-proxy
  namespace: default
  labels:
    app.kubernetes.io/name: oauth2-proxy
    app.kubernetes.io/component: secrets
spec:
  provider: azure
  parameters:
    # REQUIRED: The name of your Azure Key Vault
    keyvaultName: "<YOUR_KEYVAULT_NAME>"

    # REQUIRED: Your Azure tenant ID
    tenantId: "<YOUR_TENANT_ID>"

    # Authentication to Key Vault (recommended: Azure AD Workload Identity)
    # Set useWorkloadIdentity to "true" and specify the clientID of your user-assigned managed identity
    useWorkloadIdentity: "true"
    clientID: "<YOUR_USER_ASSIGNED_MI_CLIENT_ID>"

    # If using legacy AAD Pod Identity instead (not recommended), set:
    # usePodIdentity: "true"

    # Azure cloud
    cloudName: "AzurePublicCloud"

    # Objects to fetch from Key Vault
    objects: |
      array:
        - |
          objectName: oauth2-proxy-client-id
          objectType: secret
        - |
          objectName: oauth2-proxy-client-secret
          objectType: secret
        - |
          objectName: oauth2-proxy-cookie-secret
          objectType: secret

  # Sync to a Kubernetes Secret that the Deployment already references
  secretObjects:
  - secretName: oauth2-proxy-secret
    type: Opaque
    data:
    - objectName: oauth2-proxy-client-id
      key: client-id
    - objectName: oauth2-proxy-client-secret
      key: client-secret
    - objectName: oauth2-proxy-cookie-secret
      key: cookie-secret
