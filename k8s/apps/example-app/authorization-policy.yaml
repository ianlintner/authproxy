---
# AuthorizationPolicy that enforces authentication via ext_authz
# This policy applies to the example-app and requires successful
# authentication check from oauth2-proxy before allowing requests
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: example-app-require-auth
  namespace: example-app
  labels:
    app: example-app
    auth.cat-herding.net/enabled: "true"
spec:
  # Apply to pods with this label
  selector:
    matchLabels:
      app: example-app
      auth.cat-herding.net/enabled: "true"
  
  # CUSTOM action type means this policy defers to ext_authz
  action: CUSTOM
  
  provider:
    # This name must match the ext_authz provider configured in mesh config
    # Since we're using EnvoyFilter, this is implicitly handled
    name: oauth2-proxy
  
  rules:
  # Apply to all requests
  - to:
    - operation:
        paths: ["/*"]
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH", "HEAD", "OPTIONS"]

---
# Alternative: If the EnvoyFilter handles all auth globally,
# you might not need per-app AuthorizationPolicies.
# In that case, the ext_authz filter will check all requests automatically.
#
# However, having per-app policies allows you to:
# 1. Opt-in specific apps (via label selector)
# 2. Customize auth behavior per app
# 3. Disable auth for specific paths (e.g., health checks)
#
# Example: Allow health checks without auth
# apiVersion: security.istio.io/v1
# kind: AuthorizationPolicy
# metadata:
#   name: example-app-allow-healthcheck
#   namespace: example-app
# spec:
#   selector:
#     matchLabels:
#       app: example-app
#   action: ALLOW
#   rules:
#   - to:
#     - operation:
#         paths: ["/health", "/healthz", "/ready", "/readyz"]
