{"config":{"lang":["en"],"separator":"[\\s\\-,:!=\\[\\]()\"/]+|\\.(?!\\d)|&[lg]t;|(?!\\b)(?=[A-Z][a-z])","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"OAuth2 Sidecar Proxy","text":"<ul> <li> <p> Secure by Default</p> <p>OAuth2 authentication with industry-standard security practices. Support for GitHub, Google, Azure AD, and custom OIDC providers.</p> </li> <li> <p> Simple Architecture</p> <p>Sidecar pattern eliminates complex centralized authentication services. Each app manages its own auth lifecycle.</p> </li> <li> <p> Kubernetes Native</p> <p>Built for Kubernetes and Istio service mesh. Seamless integration with AKS and other managed Kubernetes platforms.</p> </li> <li> <p> SSO Out of the Box</p> <p>Shared cookie domain enables single sign-on across all your applications automatically.</p> </li> </ul>"},{"location":"#overview","title":"Overview","text":"<p>OAuth2 Sidecar Proxy provides a simple, secure way to add OAuth2 authentication to your Kubernetes applications using the sidecar pattern. Each application pod includes an <code>oauth2-proxy</code> container that handles authentication before requests reach your application.</p> <pre><code>graph LR\n    A[User] --&gt;|HTTPS| B[Istio Gateway]\n    B --&gt; C[Service :4180]\n    C --&gt; D[Pod]\n    D --&gt; E[oauth2-proxy :4180]\n    D --&gt; F[Your App :8080]\n    E -.-&gt;|if authenticated| F\n    E --&gt;|if not| G[OAuth Provider]\n    G --&gt;|callback| E\n\n    style E fill:#4c51bf,stroke:#333,stroke-width:2px,color:#fff\n    style F fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n    style G fill:#f59e0b,stroke:#333,stroke-width:2px,color:#fff\n</code></pre>"},{"location":"#key-features","title":"Key Features","text":"<ul> <li>\ud83d\udd12 Secure: OAuth2/OIDC authentication with support for major providers</li> <li>\ud83d\ude80 Simple: No complex ext_authz configuration required</li> <li>\ud83c\udfaf Isolated: Each app has its own authentication configuration</li> <li>\ud83d\udd04 Portable: Easy to migrate between clusters</li> <li>\ud83d\udc1b Debuggable: Auth logs co-located with application logs</li> <li>\ud83c\udf10 SSO: Single sign-on across all applications in your domain</li> <li>\ud83c\udfa8 Customizable: Custom sign-in pages with your branding</li> <li>\ud83d\udcca Observable: Built-in metrics and health checks</li> </ul>"},{"location":"#quick-start","title":"Quick Start","text":"<p>Get up and running in minutes:</p> <pre><code># 1. Clone the repository\ngit clone https://github.com/ianlintner/authproxy.git\ncd authproxy\n\n# 2. Configure OAuth credentials\ncp examples/simple-app/values.yaml my-values.yaml\n# Edit my-values.yaml with your OAuth app credentials\n\n# 3. Install with Helm\nhelm install oauth2-sidecar ./helm/oauth2-sidecar \\\n  --values my-values.yaml \\\n  --namespace default\n\n# 4. Deploy example app\nkubectl apply -k k8s/apps/example-app/\n\n# 5. Test it!\ncurl https://example-app.your-domain.com\n</code></pre> <p>Your app is now protected with OAuth2 authentication! \ud83c\udf89</p>"},{"location":"#how-it-works","title":"How It Works","text":"<p>The sidecar pattern places an <code>oauth2-proxy</code> container alongside your application container in the same pod:</p> <ol> <li>All traffic first hits the oauth2-proxy sidecar on port 4180</li> <li>oauth2-proxy checks for a valid session cookie</li> <li>If not authenticated, redirects user to OAuth provider (GitHub, Google, etc.)</li> <li>If authenticated, proxies the request to your app on localhost:8080</li> <li>User headers are injected (email, username, etc.) for your app to use</li> </ol> <pre><code>sequenceDiagram\n    participant User\n    participant Istio\n    participant OAuth2Proxy\n    participant App\n    participant Provider\n\n    User-&gt;&gt;Istio: GET /\n    Istio-&gt;&gt;OAuth2Proxy: Forward request\n    OAuth2Proxy-&gt;&gt;OAuth2Proxy: Check session cookie\n\n    alt Not authenticated\n        OAuth2Proxy-&gt;&gt;User: 302 Redirect to Provider\n        User-&gt;&gt;Provider: Login\n        Provider-&gt;&gt;OAuth2Proxy: Callback with code\n        OAuth2Proxy-&gt;&gt;Provider: Exchange code for token\n        Provider-&gt;&gt;OAuth2Proxy: Access token\n        OAuth2Proxy-&gt;&gt;User: 302 Redirect with cookie\n    end\n\n    OAuth2Proxy-&gt;&gt;App: Forward with headers\n    App-&gt;&gt;OAuth2Proxy: Response\n    OAuth2Proxy-&gt;&gt;User: Response\n</code></pre>"},{"location":"#architecture-benefits","title":"Architecture Benefits","text":""},{"location":"#vs-centralized-authentication","title":"vs. Centralized Authentication","text":"<p>Traditional centralized authentication services (like a shared oauth2-proxy deployment with Istio ext_authz) require:</p> <ul> <li>Complex Istio configuration</li> <li>Shared state management</li> <li>Difficult debugging across services</li> <li>Tight coupling between apps</li> </ul> <p>Our sidecar approach provides:</p> <ul> <li>\u2705 Simpler configuration - No ext_authz filter needed</li> <li>\u2705 Better isolation - Each app's auth is independent</li> <li>\u2705 Easier debugging - Auth logs are with app logs</li> <li>\u2705 More flexible - Different OAuth providers per app</li> <li>\u2705 More portable - Apps can move between clusters easily</li> </ul>"},{"location":"#performance-considerations","title":"Performance Considerations","text":"<p>The sidecar pattern adds minimal overhead:</p> <ul> <li>Latency: ~1-5ms for authenticated requests (localhost proxy)</li> <li>Memory: ~50-100MB per oauth2-proxy sidecar</li> <li>CPU: Minimal (&lt;50m) for most workloads</li> </ul> <p>Cookie-based sessions mean no database lookups on every request!</p>"},{"location":"#supported-platforms","title":"Supported Platforms","text":"<ul> <li>Kubernetes: 1.20+</li> <li>Istio: 1.14+ (including AKS Istio addon)</li> <li>OAuth Providers:<ul> <li>GitHub</li> <li>Google</li> <li>Azure AD / Microsoft Entra ID</li> <li>Any OIDC-compliant provider</li> <li>LinkedIn, Facebook, GitLab, and more</li> </ul> </li> </ul>"},{"location":"#whats-next","title":"What's Next?","text":"<ul> <li> <p> Quick Start Guide</p> <p>Get your first authenticated app running in 5 minutes</p> </li> <li> <p> Architecture Deep Dive</p> <p>Understand how the sidecar pattern works</p> </li> <li> <p> Configuration Reference</p> <p>Complete guide to all configuration options</p> </li> <li> <p> Troubleshooting</p> <p>Common issues and how to solve them</p> </li> </ul>"},{"location":"#community-support","title":"Community &amp; Support","text":"<ul> <li>GitHub: Issues | Discussions</li> <li>Documentation: You're reading it!</li> <li>Contributing: See Contributing Guide</li> </ul>"},{"location":"#license","title":"License","text":"<p>This project is licensed under the MIT License - see the LICENSE file for details.</p>"},{"location":"ADDING_APPS/","title":"Adding OAuth2 Authentication to Your Applications","text":"<p>This guide walks you through adding OAuth2 authentication to new or existing applications using the sidecar pattern.</p>"},{"location":"ADDING_APPS/#table-of-contents","title":"Table of Contents","text":"<ul> <li>Prerequisites</li> <li>Method 1: Deploy New App with Authentication</li> <li>Method 2: Add Authentication to Existing App</li> <li>Testing Your Setup</li> <li>Customization Options</li> <li>Troubleshooting</li> </ul>"},{"location":"ADDING_APPS/#prerequisites","title":"Prerequisites","text":"<p>Before adding authentication to your app, ensure:</p> <ol> <li> <p>Base infrastructure is deployed:    <pre><code>./scripts/setup.sh\n</code></pre></p> </li> <li> <p>OAuth secret exists:    <pre><code>kubectl get secret oauth2-proxy-secret -n default\n</code></pre></p> </li> <li> <p>DNS is configured: <code>*.cat-herding.net</code> points to Istio ingress gateway</p> </li> <li> <p>TLS certificate is ready:    <pre><code>kubectl get secret cat-herding-wildcard-tls -n aks-istio-ingress\n</code></pre></p> </li> </ol>"},{"location":"ADDING_APPS/#method-1-deploy-new-app-with-authentication","title":"Method 1: Deploy New App with Authentication","text":"<p>Use the complete example in <code>k8s/apps/example-app/</code> as your starting point.</p> <p>Key points: - oauth2-proxy sidecar listens on port 4180 - Your app container listens on port 8080 (configurable) - Service exposes port 4180 - VirtualService routes to port 4180</p> <p>See <code>k8s/apps/example-app/README.md</code> for detailed instructions.</p>"},{"location":"ADDING_APPS/#method-2-add-authentication-to-existing-app","title":"Method 2: Add Authentication to Existing App","text":""},{"location":"ADDING_APPS/#automated-recommended","title":"Automated (Recommended)","text":"<pre><code>./scripts/add-sidecar.sh &lt;app-name&gt; &lt;namespace&gt; &lt;app-port&gt; &lt;domain&gt;\n\n# Example:\n./scripts/add-sidecar.sh myapp default 8080 myapp.cat-herding.net\n</code></pre> <p>This script automatically: - \u2705 Adds oauth2-proxy sidecar to deployment - \u2705 Updates service to expose port 4180 - \u2705 Creates/updates VirtualService - \u2705 Deploys changes</p>"},{"location":"ADDING_APPS/#manual","title":"Manual","text":"<p>See the complete manual steps in the full guide.</p>"},{"location":"ADDING_APPS/#testing-your-setup","title":"Testing Your Setup","text":"<pre><code># 1. Check pods running\nkubectl get pods -l app=myapp\n\n# 2. Test authentication\ncurl -v https://myapp.cat-herding.net\n# Should redirect to OAuth provider (302)\n\n# 3. Test in browser\n# - Visit https://myapp.cat-herding.net\n# - Should redirect to GitHub/Google\n# - Log in\n# - Should redirect back to app\n\n# 4. Test SSO\n# - Log in to app1.cat-herding.net\n# - Visit app2.cat-herding.net\n# - Should be automatically logged in\n</code></pre>"},{"location":"ADDING_APPS/#customization-options","title":"Customization Options","text":""},{"location":"ADDING_APPS/#different-app-port","title":"Different App Port","text":"<pre><code>env:\n- name: OAUTH2_PROXY_UPSTREAMS\n  value: \"http://127.0.0.1:3000\"  # Your app port\n</code></pre>"},{"location":"ADDING_APPS/#restrict-email-domain","title":"Restrict Email Domain","text":"<pre><code>env:\n- name: OAUTH2_PROXY_EMAIL_DOMAINS\n  value: \"mycompany.com\"\n</code></pre>"},{"location":"ADDING_APPS/#different-oauth-provider","title":"Different OAuth Provider","text":"<p>Update ConfigMap: <pre><code>provider = \"google\"\n# OR\nprovider = \"azure\"\n</code></pre></p>"},{"location":"ADDING_APPS/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ADDING_APPS/#503-service-unavailable","title":"503 Service Unavailable","text":"<pre><code># Check pods\nkubectl get pods -l app=myapp\n\n# Check logs\nkubectl logs &lt;pod-name&gt; -c oauth2-proxy\nkubectl logs &lt;pod-name&gt; -c app\n</code></pre>"},{"location":"ADDING_APPS/#redirect-loop","title":"Redirect Loop","text":"<p>Check redirect URL matches domain: <pre><code>kubectl get deployment myapp -o yaml | grep REDIRECT_URL\n</code></pre></p> <p>Should be: <code>https://myapp.cat-herding.net/oauth2/callback</code></p>"},{"location":"ADDING_APPS/#user-headers-not-available","title":"User Headers Not Available","text":"<p>Verify in ConfigMap: <pre><code>pass_user_headers = true\nset_xauthrequest = true\n</code></pre></p> <p>Your app should read: - <code>X-Auth-Request-User</code> - <code>X-Auth-Request-Email</code></p>"},{"location":"ADDING_APPS/#next-steps","title":"Next Steps","text":"<ul> <li>Review ARCHITECTURE.md for detailed design</li> <li>See example: <code>k8s/apps/example-app/</code></li> <li>Run validation: <code>./scripts/validate.sh</code></li> </ul>"},{"location":"ARCHITECTURE/","title":"Architecture: OAuth2 Sidecar Authentication","text":""},{"location":"ARCHITECTURE/#overview","title":"Overview","text":"<p>This architecture implements OAuth2 authentication for AKS applications using a sidecar pattern. Each application pod includes an <code>oauth2-proxy</code> container that handles authentication before requests reach the application container.</p> <p>Key Characteristics: - Decentralized: No shared authentication service - Simple: No complex Istio ext_authz configuration - Isolated: Each app manages its own authentication - Portable: Easy to migrate between clusters</p>"},{"location":"ARCHITECTURE/#architecture-diagram","title":"Architecture Diagram","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                        Internet / Users                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                               \u2502\n                               \u2502 HTTPS (*.cat-herding.net)\n                               \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Azure Load Balancer                             \u2502\n\u2502                    (AKS Public IP)                                 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                               \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  Istio Ingress Gateway                             \u2502\n\u2502                  (aks-istio-ingressgateway-external)               \u2502\n\u2502                                                                    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502  Gateway: *.cat-herding.net                              \u2502    \u2502\n\u2502  \u2502  - TLS Termination (wildcard cert)                       \u2502    \u2502\n\u2502  \u2502  - HTTP \u2192 HTTPS redirect                                 \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                                                                    \u2502\n\u2502  No ext_authz filter - auth handled by sidecars                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                               \u2502\n                               \u2502 Routes to Service (port 4180)\n                               \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                       Application Service                          \u2502\n\u2502                       (ClusterIP, port 4180)                       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                               \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                       Application Pod                              \u2502\n\u2502                                                                    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u2502\n\u2502  \u2502  oauth2-proxy sidecar container                      \u2502        \u2502\n\u2502  \u2502  (port 4180)                                         \u2502        \u2502\n\u2502  \u2502                                                      \u2502        \u2502\n\u2502  \u2502  1. Receives all traffic                            \u2502        \u2502\n\u2502  \u2502  2. Checks session cookie                           \u2502        \u2502\n\u2502  \u2502  3. If not auth \u2192 redirect to OAuth                 \u2502        \u2502\n\u2502  \u2502  4. If auth \u2192 proxy to localhost:8080               \u2502        \u2502\n\u2502  \u2502  5. Inject user headers                             \u2502        \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2502\n\u2502                  \u2502                                                \u2502\n\u2502                  \u2502 http://127.0.0.1:8080                         \u2502\n\u2502                  \u2502                                                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510        \u2502\n\u2502  \u2502  Application container                               \u2502        \u2502\n\u2502  \u2502  (port 8080)                                         \u2502        \u2502\n\u2502  \u2502                                                      \u2502        \u2502\n\u2502  \u2502  - Receives authenticated requests                   \u2502        \u2502\n\u2502  \u2502  - Reads user from headers                          \u2502        \u2502\n\u2502  \u2502  - No auth logic needed                             \u2502        \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518        \u2502\n\u2502                                                                    \u2502\n\u2502  Shared volumes:                                                  \u2502\n\u2502  - oauth2-proxy-config (ConfigMap)                                \u2502\n\u2502  - oauth2-proxy-secret (Secret)                                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\n                               \u2502\n                               \u2502 OAuth flow (if not authenticated)\n                               \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Social OAuth Provider                                             \u2502\n\u2502  - GitHub                                                          \u2502\n\u2502  - Google                                                          \u2502\n\u2502  - Azure AD                                                        \u2502\n\u2502  - LinkedIn                                                        \u2502\n\u2502                                                                    \u2502\n\u2502  User logs in \u2192 callback to app \u2192 cookie set                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"ARCHITECTURE/#components","title":"Components","text":""},{"location":"ARCHITECTURE/#1-istio-ingress-gateway","title":"1. Istio Ingress Gateway","text":"<p>Purpose: Entry point for all external HTTPS traffic</p> <p>Configuration: - Gateway Resource: Defines <code>*.cat-herding.net</code> hosts - TLS: Uses wildcard certificate <code>cat-herding-wildcard-tls</code> - Ports: 80 (HTTP \u2192 HTTPS redirect), 443 (HTTPS)</p> <p>Key Features: - Wildcard DNS support - Automatic TLS termination - Routes to application services (port 4180)</p> <p>No ext_authz filter: Unlike centralized auth, the gateway simply routes traffic without authentication checks.</p>"},{"location":"ARCHITECTURE/#2-oauth2-proxy-sidecar-container","title":"2. oauth2-proxy Sidecar Container","text":"<p>Purpose: Handle OAuth2 authentication within each application pod</p> <p>Configuration (<code>k8s/base/oauth2-proxy-sidecar/</code>): - Image: <code>quay.io/oauth2-proxy/oauth2-proxy:v7.6.0</code> - Port: 4180 (receives all traffic) - Upstream: <code>http://127.0.0.1:8080</code> (application container) - Config: Mounted from ConfigMap - Secrets: OAuth credentials from Secret</p> <p>Environment Variables (per-app): <pre><code>- name: OAUTH2_PROXY_REDIRECT_URL\n  value: \"https://myapp.cat-herding.net/oauth2/callback\"\n- name: OAUTH2_PROXY_UPSTREAMS  \n  value: \"http://127.0.0.1:8080\"\n</code></pre></p> <p>How It Works: 1. Receives request on port 4180 2. Checks for valid session cookie (<code>.cat-herding.net</code> domain) 3. If not authenticated:    - Redirects to OAuth provider    - Provider redirects back to <code>/oauth2/callback</code>    - Sets encrypted session cookie    - Redirects to original URL 4. If authenticated:    - Proxies request to <code>localhost:8080</code> (app container)    - Injects user headers</p> <p>Headers Injected: - <code>X-Auth-Request-User</code> - Username - <code>X-Auth-Request-Email</code> - Email address - <code>X-Auth-Request-Preferred-Username</code> - Preferred username - <code>Authorization</code> - Bearer token (if configured)</p>"},{"location":"ARCHITECTURE/#3-application-container","title":"3. Application Container","text":"<p>Purpose: Your application code</p> <p>Requirements: - Listen on port 8080 (or configure via <code>OAUTH2_PROXY_UPSTREAMS</code>) - Read user identity from request headers - No authentication logic needed</p> <p>Example (Go): <pre><code>email := r.Header.Get(\"X-Auth-Request-Email\")\nuser := r.Header.Get(\"X-Auth-Request-User\")\n</code></pre></p>"},{"location":"ARCHITECTURE/#4-service","title":"4. Service","text":"<p>Purpose: Expose the oauth2-proxy sidecar (port 4180) to Istio</p> <p>Configuration: <pre><code>apiVersion: v1\nkind: Service\nmetadata:\n  name: myapp\nspec:\n  ports:\n  - name: proxy\n    port: 4180\n    targetPort: 4180\n  selector:\n    app: myapp\n</code></pre></p> <p>Key Point: Service routes to port 4180 (oauth2-proxy), not directly to app</p>"},{"location":"ARCHITECTURE/#5-virtualservice","title":"5. VirtualService","text":"<p>Purpose: Route traffic from hostname to Service</p> <p>Configuration: <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: myapp\nspec:\n  hosts:\n  - \"myapp.cat-herding.net\"\n  gateways:\n  - istio-system/main-gateway\n  http:\n  - route:\n    - destination:\n        host: myapp.default.svc.cluster.local\n        port:\n          number: 4180\n</code></pre></p>"},{"location":"ARCHITECTURE/#traffic-flow","title":"Traffic Flow","text":""},{"location":"ARCHITECTURE/#first-time-access-not-authenticated","title":"First-Time Access (Not Authenticated)","text":"<pre><code>1. User visits https://myapp.cat-herding.net\n   \u2193\n2. Istio Gateway (TLS termination)\n   \u2193\n3. VirtualService routes to Service:4180\n   \u2193\n4. Service routes to Pod oauth2-proxy:4180\n   \u2193\n5. oauth2-proxy checks cookie \u2192 NOT FOUND\n   \u2193\n6. oauth2-proxy returns 302 redirect to GitHub\n   \u2193\n7. User logs in at GitHub\n   \u2193\n8. GitHub redirects to /oauth2/callback\n   \u2193\n9. oauth2-proxy exchanges code for token\n   \u2193\n10. oauth2-proxy sets encrypted cookie (.cat-herding.net)\n   \u2193\n11. oauth2-proxy returns 302 redirect to original URL\n   \u2193\n12. User's browser re-requests with cookie\n</code></pre>"},{"location":"ARCHITECTURE/#subsequent-access-authenticated","title":"Subsequent Access (Authenticated)","text":"<pre><code>1. User visits https://myapp.cat-herding.net\n   (Cookie: _oauth2_proxy=encrypted_session)\n   \u2193\n2. Istio Gateway (TLS termination)\n   \u2193\n3. VirtualService routes to Service:4180\n   \u2193\n4. Service routes to Pod oauth2-proxy:4180\n   \u2193\n5. oauth2-proxy checks cookie \u2192 VALID\n   \u2193\n6. oauth2-proxy proxies to localhost:8080\n   (Injects headers: X-Auth-Request-Email, X-Auth-Request-User)\n   \u2193\n7. Application container receives request\n   \u2193\n8. Application reads user from headers\n   \u2193\n9. Application returns response\n   \u2193\n10. oauth2-proxy proxies response back to user\n</code></pre>"},{"location":"ARCHITECTURE/#single-sign-on-sso","title":"Single Sign-On (SSO)","text":"<p>How SSO Works Across Apps:</p> <ol> <li>User logs in at <code>app1.cat-herding.net</code></li> <li>Cookie set with domain <code>.cat-herding.net</code></li> <li>User visits <code>app2.cat-herding.net</code></li> <li>Browser automatically sends <code>.cat-herding.net</code> cookie</li> <li>app2's oauth2-proxy sidecar validates cookie</li> <li>User is authenticated without re-login!</li> </ol> <p>Requirements for SSO: - All apps use same cookie domain (<code>.cat-herding.net</code>) - All apps use same OAuth provider and client credentials - All apps deploy oauth2-proxy with identical secret</p>"},{"location":"ARCHITECTURE/#comparison-sidecar-vs-centralized","title":"Comparison: Sidecar vs Centralized","text":"Aspect Sidecar Pattern (New) Centralized ext_authz (Old) Complexity Low - simple pod config High - Istio ext_authz filter Debugging Easy - logs in same pod Hard - separate service Isolation High - per-app config Low - shared config Performance Fast - localhost proxy Slower - network call Portability Easy - self-contained Hard - Istio specific Scaling Auto - scales with app Manual - separate deployment Failure Impact Per-app only All apps affected"},{"location":"ARCHITECTURE/#security-considerations","title":"Security Considerations","text":""},{"location":"ARCHITECTURE/#1-cookie-security","title":"1. Cookie Security","text":"<ul> <li>Domain: <code>.cat-herding.net</code> (enables SSO)</li> <li>Secure: true (HTTPS only)</li> <li>HttpOnly: true (prevents JavaScript access)</li> <li>SameSite: lax (balance security/usability)</li> <li>Encryption: AES-256 with cookie secret</li> </ul>"},{"location":"ARCHITECTURE/#2-secret-management","title":"2. Secret Management","text":"<p>Required Secrets: - <code>client-id</code>: OAuth application ID - <code>client-secret</code>: OAuth application secret - <code>cookie-secret</code>: 32-byte random string for cookie encryption</p> <p>Best Practices: - Never commit secrets to git - Use Kubernetes Secrets or Azure Key Vault - Rotate cookie secret periodically - Use different OAuth apps per environment (dev/staging/prod)</p>"},{"location":"ARCHITECTURE/#3-network-security","title":"3. Network Security","text":"<ul> <li>All traffic encrypted with TLS</li> <li>oauth2-proxy to app communication on localhost only</li> <li>No external access to app port (8080)</li> <li>Only oauth2-proxy port (4180) exposed via Service</li> </ul>"},{"location":"ARCHITECTURE/#configuration-options","title":"Configuration Options","text":""},{"location":"ARCHITECTURE/#per-app-customization","title":"Per-App Customization","text":"<p>Each app can customize via environment variables:</p> <pre><code>env:\n- name: OAUTH2_PROXY_REDIRECT_URL\n  value: \"https://myapp.cat-herding.net/oauth2/callback\"\n- name: OAUTH2_PROXY_UPSTREAMS\n  value: \"http://127.0.0.1:8080\"\n- name: OAUTH2_PROXY_EMAIL_DOMAINS\n  value: \"mycompany.com\"  # Restrict to specific domain\n</code></pre>"},{"location":"ARCHITECTURE/#different-oauth-providers","title":"Different OAuth Providers","text":"<p>Update ConfigMap to change provider:</p> <pre><code>provider = \"google\"\n# OR\nprovider = \"azure\"\nazure_tenant = \"your-tenant-id\"\n# OR\nprovider = \"oidc\"\noidc_issuer_url = \"https://your-issuer\"\n</code></pre>"},{"location":"ARCHITECTURE/#custom-session-duration","title":"Custom Session Duration","text":"<pre><code>cookie_expire = \"24h\"    # Session expires after 24 hours\ncookie_refresh = \"15m\"   # Refresh token every 15 minutes\n</code></pre>"},{"location":"ARCHITECTURE/#monitoring-and-observability","title":"Monitoring and Observability","text":""},{"location":"ARCHITECTURE/#logs","title":"Logs","text":"<p>View oauth2-proxy sidecar logs: <pre><code>kubectl logs -n &lt;namespace&gt; &lt;pod-name&gt; -c oauth2-proxy\n</code></pre></p> <p>View application logs: <pre><code>kubectl logs -n &lt;namespace&gt; &lt;pod-name&gt; -c app\n</code></pre></p>"},{"location":"ARCHITECTURE/#metrics","title":"Metrics","text":"<p>oauth2-proxy exposes Prometheus metrics (if configured): - Request counts - Authentication success/failure rates - Session duration - OAuth provider latency</p>"},{"location":"ARCHITECTURE/#health-checks","title":"Health Checks","text":"<p>oauth2-proxy health endpoint: <pre><code>curl http://localhost:4180/ping\n</code></pre></p>"},{"location":"ARCHITECTURE/#deployment-patterns","title":"Deployment Patterns","text":""},{"location":"ARCHITECTURE/#pattern-1-new-application","title":"Pattern 1: New Application","text":"<ol> <li>Write your application (no auth logic)</li> <li>Create Deployment with oauth2-proxy sidecar</li> <li>Create Service exposing port 4180</li> <li>Create VirtualService routing to Service:4180</li> <li>Deploy with <code>kubectl apply</code></li> </ol> <p>See: <code>k8s/apps/example-app/</code></p>"},{"location":"ARCHITECTURE/#pattern-2-existing-application","title":"Pattern 2: Existing Application","text":"<ol> <li> <p>Use helper script:    <pre><code>./scripts/add-sidecar.sh myapp default 8080 myapp.cat-herding.net\n</code></pre></p> </li> <li> <p>Script automatically:</p> </li> <li>Patches Deployment with sidecar</li> <li>Updates Service</li> <li>Creates/updates VirtualService</li> </ol>"},{"location":"ARCHITECTURE/#pattern-3-kustomize","title":"Pattern 3: Kustomize","text":"<p>Use Kustomize patches to add sidecar to multiple apps:</p> <pre><code>patchesStrategicMerge:\n- oauth2-sidecar-patch.yaml\n</code></pre>"},{"location":"ARCHITECTURE/#troubleshooting","title":"Troubleshooting","text":""},{"location":"ARCHITECTURE/#issue-redirect-loop","title":"Issue: Redirect Loop","text":"<p>Symptom: Browser keeps redirecting between app and OAuth provider</p> <p>Causes: - <code>OAUTH2_PROXY_REDIRECT_URL</code> doesn't match actual domain - Cookie domain incorrect - HTTPS not properly configured</p> <p>Fix: <pre><code># Check redirect URL\nkubectl get deployment myapp -o yaml | grep REDIRECT_URL\n\n# Should match: https://myapp.cat-herding.net/oauth2/callback\n</code></pre></p>"},{"location":"ARCHITECTURE/#issue-503-service-unavailable","title":"Issue: 503 Service Unavailable","text":"<p>Symptom: Cannot access application</p> <p>Causes: - oauth2-proxy sidecar not running - App container not running - Service not routing to correct port</p> <p>Fix: <pre><code># Check pod status\nkubectl get pods -l app=myapp\n\n# Check both containers are running\nkubectl get pod &lt;pod-name&gt; -o jsonpath='{.status.containerStatuses[*].name}'\n\n# Check Service\nkubectl get svc myapp -o yaml\n# Verify port 4180 is listed\n</code></pre></p>"},{"location":"ARCHITECTURE/#issue-user-headers-not-available","title":"Issue: User Headers Not Available","text":"<p>Symptom: Application can't read user identity</p> <p>Causes: - Application reading wrong headers - oauth2-proxy not injecting headers</p> <p>Fix: <pre><code># Check oauth2-proxy config\nkubectl get configmap oauth2-proxy-sidecar-config -o yaml\n\n# Verify these are set:\n# pass_user_headers = true\n# set_xauthrequest = true\n</code></pre></p>"},{"location":"ARCHITECTURE/#migration-from-centralized-auth","title":"Migration from Centralized Auth","text":"<p>If migrating from the old centralized ext_authz pattern:</p> <ol> <li> <p>Deploy new infrastructure:    <pre><code>./scripts/setup.sh\n</code></pre></p> </li> <li> <p>Migrate one app at a time:    <pre><code>./scripts/add-sidecar.sh app1 default 8080 app1.cat-herding.net\n</code></pre></p> </li> <li> <p>Verify app works before migrating next</p> </li> <li> <p>After all apps migrated, remove old resources:</p> </li> <li>Delete centralized oauth2-proxy Deployment</li> <li>Delete ext-authz EnvoyFilter</li> <li> <p>Delete auth VirtualService</p> </li> <li> <p>Clean up old configuration</p> </li> </ol>"},{"location":"ARCHITECTURE/#future-enhancements","title":"Future Enhancements","text":"<p>Possible improvements to this architecture:</p> <ol> <li>Automatic sidecar injection via mutating webhook</li> <li>Shared session store with Redis for larger deployments</li> <li>Custom error pages per application</li> <li>Rate limiting at oauth2-proxy level</li> <li>Multiple OAuth providers per app (provider selection page)</li> <li>Session analytics and monitoring dashboard</li> </ol>"},{"location":"ARCHITECTURE/#references","title":"References","text":"<ul> <li>oauth2-proxy Documentation</li> <li>Istio Gateway</li> <li>Kubernetes Sidecar Pattern</li> <li>OAuth 2.0 RFC</li> </ul> <p>Example: <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: example-app\n  namespace: example-app\nspec:\n  hosts:\n  - \"example-app.cat-herding.net\"\n  gateways:\n  - istio-system/cat-herding-gateway\n  http:\n  - route:\n    - destination:\n        host: example-app.example-app.svc.cluster.local\n</code></pre></p> <p>Per-App Pattern: - Each app gets its own VirtualService - Routes specific hostname to app service - Uses shared <code>cat-herding-gateway</code></p>"},{"location":"ARCHITECTURE/#5-authorizationpolicies","title":"5. AuthorizationPolicies","text":"<p>Purpose: Enforce authentication requirements per app</p> <p>Type: CUSTOM (defers to ext_authz)</p> <p>Selector: Targets pods with label <code>auth.cat-herding.net/enabled: \"true\"</code></p> <p>Why Per-App Policies?: - Opt-in model: apps explicitly enable auth - Flexibility: some apps can exclude specific paths (e.g., health checks) - Granular control: different auth rules per app if needed</p> <p>Alternative Approach: The EnvoyFilter already checks ALL requests globally. AuthorizationPolicies provide additional control and documentation.</p>"},{"location":"ARCHITECTURE/#authentication-flow-detailed","title":"Authentication Flow (Detailed)","text":""},{"location":"ARCHITECTURE/#first-request-unauthenticated-user","title":"First Request (Unauthenticated User)","text":"<pre><code>1. User visits: https://chat.cat-herding.net\n   \u2514\u2500&gt; DNS resolves to Istio ingress LoadBalancer IP\n\n2. Request hits Istio Ingress Gateway\n   \u2514\u2500&gt; TLS terminated with wildcard cert\n   \u2514\u2500&gt; EnvoyFilter ext_authz intercepts request\n\n3. Envoy calls oauth2-proxy auth check:\n   POST http://oauth2-proxy.auth:4180/oauth2/auth\n   Headers: Cookie, X-Forwarded-*\n\n4. oauth2-proxy checks session:\n   \u2514\u2500&gt; No valid cookie found\n   \u2514\u2500&gt; Returns 302 redirect to GitHub OAuth\n\n5. Envoy forwards 302 to client\n\n6. Browser redirects to GitHub:\n   https://github.com/login/oauth/authorize?\n     client_id=...&amp;\n     redirect_uri=https://auth.cat-herding.net/oauth2/callback&amp;\n     state=...\n\n7. User authenticates with GitHub\n\n8. GitHub redirects to callback:\n   https://auth.cat-herding.net/oauth2/callback?code=...&amp;state=...\n\n9. Request hits Istio \u2192 routes to oauth2-proxy (VirtualService)\n\n10. oauth2-proxy handles callback:\n    \u2514\u2500&gt; Exchanges code for token with GitHub\n    \u2514\u2500&gt; Creates session\n    \u2514\u2500&gt; Sets encrypted cookie: _oauth2_proxy\n        Domain: .cat-herding.net (SSO!)\n        HttpOnly: true\n        Secure: true\n        SameSite: Lax\n    \u2514\u2500&gt; Returns 302 redirect to original URL: https://chat.cat-herding.net\n\n11. Browser follows redirect with cookie\n\n12. Request hits Istio again\n    \u2514\u2500&gt; EnvoyFilter calls oauth2-proxy auth check\n    \u2514\u2500&gt; oauth2-proxy validates cookie\n    \u2514\u2500&gt; Returns 202 with user headers:\n        X-Auth-Request-User: githubuser\n        X-Auth-Request-Email: user@example.com\n\n13. Envoy forwards request to backend with headers\n\n14. Backend receives authenticated request\n</code></pre>"},{"location":"ARCHITECTURE/#subsequent-requests-authenticated-user","title":"Subsequent Requests (Authenticated User)","text":"<pre><code>1. User visits: https://dsa.cat-herding.net\n   \u2514\u2500&gt; Browser includes cookie (domain: .cat-herding.net)\n\n2. Request hits Istio Ingress Gateway\n   \u2514\u2500&gt; EnvoyFilter calls oauth2-proxy auth check\n\n3. oauth2-proxy validates cookie:\n   \u2514\u2500&gt; Cookie is valid and not expired\n   \u2514\u2500&gt; Returns 202 with user headers\n\n4. Envoy forwards request to backend\n\n5. User is authenticated \u2192 SSO works!\n</code></pre>"},{"location":"ARCHITECTURE/#security-model","title":"Security Model","text":""},{"location":"ARCHITECTURE/#tlshttps","title":"TLS/HTTPS","text":"<ul> <li>Wildcard Certificate: <code>*.cat-herding.net</code></li> <li>Managed By: cert-manager (Let's Encrypt or other CA)</li> <li>Termination: At Istio ingress gateway</li> <li>Backend: HTTP (within cluster, mTLS via Istio)</li> </ul>"},{"location":"ARCHITECTURE/#session-management","title":"Session Management","text":"<ul> <li>Storage: Cookie-based (no external storage)</li> <li>Encryption: AES-256 (cookie secret)</li> <li>Cookie Attributes:</li> <li><code>HttpOnly</code>: Prevents JavaScript access</li> <li><code>Secure</code>: HTTPS only</li> <li><code>SameSite: Lax</code>: CSRF protection</li> <li><code>Domain: .cat-herding.net</code>: SSO across subdomains</li> </ul>"},{"location":"ARCHITECTURE/#oauth-token-handling","title":"OAuth Token Handling","text":"<ul> <li>Access Token: Not stored in cookie (too large)</li> <li>Refresh Token: Used by oauth2-proxy to refresh session</li> <li>Token Expiry: Automatic refresh every 1 hour</li> <li>Revocation: Delete cookie or restart oauth2-proxy</li> </ul>"},{"location":"ARCHITECTURE/#network-security","title":"Network Security","text":"<ul> <li>Ingress: Only through Istio gateway (TLS required)</li> <li>Internal: Istio mTLS encrypts pod-to-pod traffic</li> <li>oauth2-proxy: ClusterIP service (not exposed externally)</li> <li>Backend Apps: ClusterIP services (not exposed externally)</li> </ul>"},{"location":"ARCHITECTURE/#scalability","title":"Scalability","text":""},{"location":"ARCHITECTURE/#oauth2-proxy","title":"oauth2-proxy","text":"<ul> <li>Stateless: Can scale horizontally</li> <li>Replicas: 2 (HA setup)</li> <li>No Database: Cookie-based sessions</li> <li>Resource Limits: 500m CPU, 256Mi memory</li> </ul>"},{"location":"ARCHITECTURE/#istio-ingress-gateway","title":"Istio Ingress Gateway","text":"<ul> <li>Replicas: Managed by Istio operator (typically 2-3)</li> <li>Auto-scaling: HPA configured</li> <li>Connection Pooling: Envoy handles efficiently</li> </ul>"},{"location":"ARCHITECTURE/#backend-applications","title":"Backend Applications","text":"<ul> <li>Independent Scaling: Each app scales independently</li> <li>No Auth Logic: Apps don't need to implement OAuth</li> <li>Simple Integration: Just read headers</li> </ul>"},{"location":"ARCHITECTURE/#observability","title":"Observability","text":""},{"location":"ARCHITECTURE/#logging","title":"Logging","text":"<p>oauth2-proxy Logs: - Authentication events (success/failure) - User identity (email, username) - OAuth provider - Requested URL - Source IP</p> <p>Format: <pre><code>{\n  \"timestamp\": \"2025-11-27T10:00:00Z\",\n  \"level\": \"info\",\n  \"msg\": \"AuthSuccess\",\n  \"user\": \"githubuser\",\n  \"email\": \"user@example.com\",\n  \"provider\": \"github\",\n  \"url\": \"https://chat.cat-herding.net/\",\n  \"client_ip\": \"1.2.3.4\"\n}\n</code></pre></p> <p>Istio Access Logs: - All requests through ingress gateway - Response codes, latencies - Upstream services</p>"},{"location":"ARCHITECTURE/#metrics_1","title":"Metrics","text":"<p>oauth2-proxy Metrics (Prometheus format on port 44180): - <code>oauth2_proxy_requests_total</code>: Total requests - <code>oauth2_proxy_authentication_total{result=\"success|failure\"}</code>: Auth attempts - <code>oauth2_proxy_upstream_requests_total</code>: Upstream requests</p> <p>Istio Metrics: - Request rate, error rate, latency (RED metrics) - Service-to-service traffic - ext_authz check latencies</p>"},{"location":"ARCHITECTURE/#tracing","title":"Tracing","text":"<ul> <li>Distributed Tracing: Via Istio (Jaeger/Zipkin)</li> <li>Trace Propagation: Headers forwarded through ext_authz</li> <li>End-to-End Visibility: User request \u2192 auth check \u2192 backend</li> </ul>"},{"location":"ARCHITECTURE/#failure-modes","title":"Failure Modes","text":""},{"location":"ARCHITECTURE/#oauth2-proxy-down","title":"oauth2-proxy Down","text":"<p>Behavior: <code>failure_mode_allow: false</code> in EnvoyFilter</p> <ul> <li>All requests return 503 Service Unavailable</li> <li>No traffic reaches backends</li> <li>Users cannot authenticate or access apps</li> </ul> <p>Mitigation: - 2 replicas with pod anti-affinity - Health checks and auto-restart - Monitor oauth2-proxy availability</p>"},{"location":"ARCHITECTURE/#oauth-provider-down","title":"OAuth Provider Down","text":"<p>Behavior: - Existing sessions continue to work (cookie-based) - New logins fail - Token refresh fails (after expiry)</p> <p>Mitigation: - Long cookie expiry (7 days) - Multiple OAuth providers configured - Clear error messages to users</p>"},{"location":"ARCHITECTURE/#certificate-expiry","title":"Certificate Expiry","text":"<p>Behavior: - HTTPS fails - Browsers show certificate error - No traffic can reach apps</p> <p>Mitigation: - cert-manager auto-renewal - Monitoring for certificate expiry - Alerts 30 days before expiration</p>"},{"location":"ARCHITECTURE/#envoy-config-propagation-delay","title":"Envoy Config Propagation Delay","text":"<p>Behavior: - Brief period where config is inconsistent - Some ingress pods have old config</p> <p>Mitigation: - Wait 10-30s after applying EnvoyFilter - Gradual rollouts - Test in dev environment first</p>"},{"location":"ARCHITECTURE/#comparison-with-alternatives","title":"Comparison with Alternatives","text":""},{"location":"ARCHITECTURE/#vs-per-app-oauth-implementation","title":"vs. Per-App OAuth Implementation","text":"Aspect Centralized (This) Per-App Implementation Once Every app Maintenance Centralized Distributed SSO Yes (.cat-herding.net) No (per-app sessions) User Experience Seamless Login per app Security Updates One place Every app Language Agnostic Yes Depends on app"},{"location":"ARCHITECTURE/#vs-istio-requestauthentication-jwt","title":"vs. Istio RequestAuthentication (JWT)","text":"Aspect oauth2-proxy JWT-based Session Type Cookie Bearer token Client Support Browser (automatic) API clients Token Refresh Automatic Manual Social Login Easy Requires IdP integration Use Case Web apps APIs, mobile apps"},{"location":"ARCHITECTURE/#vs-kubernetes-ingress-oauth2-proxy","title":"vs. Kubernetes Ingress + OAuth2 Proxy","text":"Aspect Istio ext_authz Ingress Annotations Integration Native (EnvoyFilter) Annotations Flexibility High Limited Observability Istio metrics/tracing Basic Multi-cluster Yes (Istio mesh) No"},{"location":"ARCHITECTURE/#best-practices","title":"Best Practices","text":"<ol> <li>Cookie Secret Rotation: Rotate cookie secret periodically (invalidates sessions)</li> <li>Monitor Auth Metrics: Track auth success/failure rates</li> <li>Health Checks Exclusion: Exempt <code>/health</code>, <code>/readyz</code> from auth</li> <li>Graceful Degradation: Implement fallback for auth failures</li> <li>Test in Dev: Always test auth changes in dev overlay first</li> <li>Document OAuth Apps: Maintain list of OAuth apps and their configs</li> <li>User Logout: Provide logout endpoint: <code>https://auth.cat-herding.net/oauth2/sign_out</code></li> <li>Session Timeout: Adjust cookie expiry based on security requirements</li> <li>Audit Logs: Forward oauth2-proxy logs to SIEM for audit</li> </ol>"},{"location":"ARCHITECTURE/#troubleshooting-guide","title":"Troubleshooting Guide","text":"<p>See SETUP.md for detailed troubleshooting steps.</p>"},{"location":"ARCHITECTURE/#references_1","title":"References","text":"<ul> <li>OAuth2 Proxy Documentation</li> <li>Istio External Authorization</li> <li>Envoy ext_authz Filter</li> <li>GitHub OAuth Apps</li> </ul>"},{"location":"SETUP/","title":"Setup Guide","text":"<p>Complete step-by-step guide to deploy the SSO authentication gateway on your AKS cluster.</p>"},{"location":"SETUP/#prerequisites","title":"Prerequisites","text":""},{"location":"SETUP/#required","title":"Required","text":"<ul> <li>\u2705 AKS cluster <code>bigboy</code> in resource group <code>nekoc</code></li> <li>\u2705 Istio installed on the cluster</li> <li>\u2705 cert-manager installed</li> <li>\u2705 <code>kubectl</code> configured with cluster access</li> <li>\u2705 Domain <code>cat-herding.net</code> with DNS access</li> <li>\u2705 OAuth application registered (GitHub, Google, etc.)</li> </ul>"},{"location":"SETUP/#tools","title":"Tools","text":"<ul> <li><code>kubectl</code> (v1.20+)</li> <li><code>kustomize</code> (optional, kubectl has built-in support)</li> <li><code>openssl</code> (for generating secrets)</li> <li><code>curl</code> (for testing)</li> </ul>"},{"location":"SETUP/#step-1-verify-prerequisites","title":"Step 1: Verify Prerequisites","text":"<pre><code># Check kubectl connection\nkubectl cluster-info\n\n# Check Istio installation\nkubectl get namespace istio-system\nkubectl get deployment -n istio-system istio-ingressgateway\n\n# Check cert-manager\nkubectl get namespace cert-manager\nkubectl get pods -n cert-manager\n\n# Get ingress gateway IP\nkubectl get svc -n istio-system istio-ingressgateway\n</code></pre> <p>Note the <code>EXTERNAL-IP</code> - this is where your DNS should point.</p>"},{"location":"SETUP/#step-2-configure-dns","title":"Step 2: Configure DNS","text":"<p>Create a wildcard DNS A record for <code>*.cat-herding.net</code> pointing to your Istio ingress gateway IP.</p> <p>Azure DNS Example: <pre><code># Get the IP\nINGRESS_IP=$(kubectl get svc -n istio-system istio-ingressgateway \\\n  -o jsonpath='{.status.loadBalancer.ingress[0].ip}')\n\necho \"Point *.cat-herding.net to: $INGRESS_IP\"\n</code></pre></p> <p>Manual DNS Configuration: - Record Type: <code>A</code> - Name: <code>*</code> (wildcard) - Value: <code>&lt;INGRESS_IP&gt;</code> - TTL: <code>300</code> (or as needed)</p> <p>Verify DNS: <pre><code># Wait for DNS propagation (may take a few minutes)\nnslookup auth.cat-herding.net\nnslookup example-app.cat-herding.net\n</code></pre></p>"},{"location":"SETUP/#step-3-create-tls-certificate","title":"Step 3: Create TLS Certificate","text":"<p>If you don't already have a wildcard certificate, create one with cert-manager.</p>"},{"location":"SETUP/#option-a-lets-encrypt-http-01-challenge","title":"Option A: Let's Encrypt (HTTP-01 Challenge)","text":"<pre><code># Save as tls-certificate.yaml\napiVersion: cert-manager.io/v1\nkind: ClusterIssuer\nmetadata:\n  name: letsencrypt-prod\nspec:\n  acme:\n    server: https://acme-v02.api.letsencrypt.org/directory\n    email: your-email@example.com  # Change this!\n    privateKeySecretRef:\n      name: letsencrypt-prod-key\n    solvers:\n    - http01:\n        ingress:\n          class: istio\n\n---\napiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: cat-herding-wildcard\n  namespace: istio-system\nspec:\n  secretName: cat-herding-wildcard-tls\n  duration: 2160h # 90 days\n  renewBefore: 360h # 15 days\n  issuerRef:\n    name: letsencrypt-prod\n    kind: ClusterIssuer\n  dnsNames:\n  - \"*.cat-herding.net\"\n  - \"cat-herding.net\"\n</code></pre> <p>Apply: <pre><code>kubectl apply -f tls-certificate.yaml\n\n# Wait for certificate to be ready\nkubectl wait --for=condition=ready certificate/cat-herding-wildcard \\\n  -n istio-system --timeout=300s\n\n# Verify\nkubectl get certificate -n istio-system cat-herding-wildcard\nkubectl get secret -n istio-system cat-herding-wildcard-tls\n</code></pre></p>"},{"location":"SETUP/#option-b-bring-your-own-certificate","title":"Option B: Bring Your Own Certificate","text":"<pre><code># If you have existing cert and key files\nkubectl create secret tls cat-herding-wildcard-tls \\\n  -n istio-system \\\n  --cert=path/to/cert.pem \\\n  --key=path/to/key.pem\n</code></pre>"},{"location":"SETUP/#step-4-register-oauth-application","title":"Step 4: Register OAuth Application","text":"<p>Choose your OAuth provider and register an application.</p>"},{"location":"SETUP/#github-oauth-app","title":"GitHub OAuth App","text":"<ol> <li>Go to: https://github.com/settings/developers</li> <li>Click \"New OAuth App\"</li> <li>Fill in:</li> <li>Application name: <code>Cat Herding SSO</code></li> <li>Homepage URL: <code>https://cat-herding.net</code></li> <li>Authorization callback URL: <code>https://auth.cat-herding.net/oauth2/callback</code></li> <li>Click \"Register application\"</li> <li>Note the Client ID</li> <li>Generate a Client Secret</li> </ol>"},{"location":"SETUP/#google-oauth-20-client","title":"Google OAuth 2.0 Client","text":"<ol> <li>Go to: https://console.cloud.google.com/apis/credentials</li> <li>Create credentials \u2192 OAuth 2.0 Client ID</li> <li>Application type: Web application</li> <li>Authorized redirect URIs: <code>https://auth.cat-herding.net/oauth2/callback</code></li> <li>Note the Client ID and Client Secret</li> </ol>"},{"location":"SETUP/#azure-ad-b2c","title":"Azure AD B2C","text":"<ol> <li>Go to Azure Portal \u2192 Azure AD B2C</li> <li>App registrations \u2192 New registration</li> <li>Name: <code>Cat Herding SSO</code></li> <li>Redirect URI: <code>https://auth.cat-herding.net/oauth2/callback</code></li> <li>Note Application (client) ID</li> <li>Certificates &amp; secrets \u2192 New client secret</li> <li>Note the OIDC Issuer URL from your B2C tenant</li> </ol>"},{"location":"SETUP/#step-5-configure-oauth-secrets","title":"Step 5: Configure OAuth Secrets","text":"<pre><code>cd /path/to/authproxy\n\n# Copy the example secret file\ncp k8s/base/oauth2-proxy/secret.yaml.example k8s/base/oauth2-proxy/secret.yaml\n\n# Generate a random cookie secret\nCOOKIE_SECRET=$(openssl rand -base64 32)\necho \"Cookie Secret: $COOKIE_SECRET\"\n\n# Edit the secret file with your OAuth credentials\nnano k8s/base/oauth2-proxy/secret.yaml\n</code></pre> <p>For GitHub: <pre><code>stringData:\n  client-id: \"your_github_client_id\"\n  client-secret: \"your_github_client_secret\"\n  cookie-secret: \"your_generated_cookie_secret\"\n</code></pre></p> <p>For Google: <pre><code>stringData:\n  client-id: \"your_google_client_id.apps.googleusercontent.com\"\n  client-secret: \"your_google_client_secret\"\n  cookie-secret: \"your_generated_cookie_secret\"\n</code></pre></p> <p>Also update the provider in <code>k8s/base/oauth2-proxy/deployment.yaml</code>:</p> <pre><code>args:\n- --provider=github  # Change to: google, oidc, azure, etc.\n</code></pre> <p>For OIDC providers (like Azure AD B2C), add: <pre><code>args:\n- --provider=oidc\n- --oidc-issuer-url=https://your-tenant.b2clogin.com/...\n</code></pre></p>"},{"location":"SETUP/#step-6-update-kustomization","title":"Step 6: Update Kustomization","text":"<p>Edit <code>k8s/base/kustomization.yaml</code> to include your secret:</p> <pre><code>resources:\n  # ... other resources ...\n  - oauth2-proxy/secret.yaml  # Uncomment this line\n</code></pre>"},{"location":"SETUP/#step-7-deploy-the-infrastructure","title":"Step 7: Deploy the Infrastructure","text":"<p>Run the automated setup script:</p> <pre><code>./scripts/setup.sh\n</code></pre> <p>This script will: 1. \u2705 Check prerequisites 2. \u2705 Create auth namespace 3. \u2705 Deploy oauth2-proxy 4. \u2705 Configure Istio Gateway and EnvoyFilter 5. \u2705 Validate the deployment</p> <p>Expected Output: <pre><code>[INFO] \ud83d\ude80 Setting up SSO Authentication Gateway for AKS cluster 'bigboy'\n\n[SUCCESS] Prerequisites check passed!\n[SUCCESS] OAuth2 secret configuration found!\n[INFO] Deploying base authentication infrastructure...\n[SUCCESS] oauth2-proxy deployed successfully!\n[INFO] Deploying Istio configuration...\n[SUCCESS] Istio configuration deployed successfully!\n[SUCCESS] TLS certificate 'cat-herding-wildcard-tls' found!\n[SUCCESS] Ingress IP: x.x.x.x\n[SUCCESS] All validations passed!\n\n\u2705 Authentication infrastructure deployed successfully!\n</code></pre></p>"},{"location":"SETUP/#manual-deployment-alternative","title":"Manual Deployment (Alternative)","text":"<p>If you prefer manual deployment:</p> <pre><code># Deploy base infrastructure\nkubectl apply -f k8s/base/namespace.yaml\nkubectl apply -f k8s/base/rbac/\nkubectl apply -f k8s/base/oauth2-proxy/\n\n# Deploy Istio configuration\nkubectl apply -f k8s/base/istio/\n\n# Verify\nkubectl get pods -n auth\nkubectl get gateway -n istio-system\nkubectl get envoyfilter -n istio-system\n</code></pre>"},{"location":"SETUP/#step-8-deploy-example-application","title":"Step 8: Deploy Example Application","text":"<pre><code># Deploy the example app\nkubectl apply -k k8s/apps/example-app/\n\n# Wait for pods to be ready\nkubectl wait --for=condition=ready pod \\\n  -l app=example-app -n example-app --timeout=60s\n\n# Verify\nkubectl get pods -n example-app\nkubectl get virtualservice -n example-app\nkubectl get authorizationpolicy -n example-app\n</code></pre>"},{"location":"SETUP/#step-9-test-authentication","title":"Step 9: Test Authentication","text":""},{"location":"SETUP/#test-1-check-oauth2-proxy-health","title":"Test 1: Check oauth2-proxy Health","text":"<pre><code># Internal health check\nkubectl exec -n auth deploy/oauth2-proxy -- \\\n  wget -q -O- http://localhost:4180/ping\n\n# Should output: OK\n</code></pre>"},{"location":"SETUP/#test-2-access-example-app","title":"Test 2: Access Example App","text":"<pre><code># Try to access the app\ncurl -v https://example-app.cat-herding.net\n\n# Expected: 302 redirect to OAuth provider login page\n</code></pre>"},{"location":"SETUP/#test-3-full-flow-test","title":"Test 3: Full Flow Test","text":"<ol> <li>Open browser: https://example-app.cat-herding.net</li> <li>You should be redirected to GitHub/Google/etc. login</li> <li>Log in with your social account</li> <li>You should be redirected back to the app</li> <li>Access any other <code>*.cat-herding.net</code> subdomain</li> <li>You should NOT be prompted to log in again (SSO!)</li> </ol>"},{"location":"SETUP/#test-4-validate-setup-script","title":"Test 4: Validate Setup Script","text":"<pre><code>./scripts/validate.sh example-app.cat-herding.net\n\n# Run full test\n./scripts/validate.sh example-app.cat-herding.net full\n</code></pre>"},{"location":"SETUP/#step-10-add-authentication-to-your-apps","title":"Step 10: Add Authentication to Your Apps","text":""},{"location":"SETUP/#quick-method","title":"Quick Method","text":"<p>Use the helper script:</p> <pre><code>./scripts/add-app.sh myapp myapp-namespace 8080\n</code></pre> <p>This generates VirtualService and AuthorizationPolicy for your app.</p>"},{"location":"SETUP/#manual-method","title":"Manual Method","text":"<ol> <li>Add label to your Deployment:</li> </ol> <pre><code>metadata:\n  labels:\n    auth.cat-herding.net/enabled: \"true\"\n</code></pre> <ol> <li>Create VirtualService:</li> </ol> <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: myapp\n  namespace: myapp-namespace\nspec:\n  hosts:\n  - \"myapp.cat-herding.net\"\n  gateways:\n  - istio-system/cat-herding-gateway\n  http:\n  - route:\n    - destination:\n        host: myapp.myapp-namespace.svc.cluster.local\n        port:\n          number: 8080\n</code></pre> <ol> <li>Create AuthorizationPolicy:</li> </ol> <pre><code>apiVersion: security.istio.io/v1\nkind: AuthorizationPolicy\nmetadata:\n  name: myapp-require-auth\n  namespace: myapp-namespace\nspec:\n  selector:\n    matchLabels:\n      app: myapp\n      auth.cat-herding.net/enabled: \"true\"\n  action: CUSTOM\n  provider:\n    name: oauth2-proxy\n  rules:\n  - to:\n    - operation:\n        paths: [\"/*\"]\n</code></pre> <ol> <li>Apply:</li> </ol> <pre><code>kubectl apply -f myapp-virtualservice.yaml\nkubectl apply -f myapp-authorizationpolicy.yaml\n</code></pre> <ol> <li>Test:</li> </ol> <pre><code>curl -v https://myapp.cat-herding.net\n</code></pre>"},{"location":"SETUP/#monitoring-and-maintenance","title":"Monitoring and Maintenance","text":""},{"location":"SETUP/#view-logs","title":"View Logs","text":"<pre><code># oauth2-proxy logs\nkubectl logs -n auth -l app=oauth2-proxy -f\n\n# Filter auth events\nkubectl logs -n auth -l app=oauth2-proxy | grep -i \"authsuccess\\|authfailure\"\n\n# Istio ingress gateway logs\nkubectl logs -n istio-system -l app=istio-ingressgateway -f\n</code></pre>"},{"location":"SETUP/#check-metrics","title":"Check Metrics","text":"<pre><code># oauth2-proxy metrics\nkubectl port-forward -n auth svc/oauth2-proxy 44180:44180\ncurl http://localhost:44180/metrics\n\n# Look for:\n# oauth2_proxy_requests_total\n# oauth2_proxy_authentication_total\n</code></pre>"},{"location":"SETUP/#update-oauth-credentials","title":"Update OAuth Credentials","text":"<pre><code># Edit the secret\nkubectl edit secret -n auth oauth2-proxy-secret\n\n# Or replace the secret file and reapply\nkubectl apply -f k8s/base/oauth2-proxy/secret.yaml\n\n# Restart oauth2-proxy to pick up changes\nkubectl rollout restart deployment/oauth2-proxy -n auth\n</code></pre>"},{"location":"SETUP/#rotate-cookie-secret","title":"Rotate Cookie Secret","text":"<pre><code># Generate new secret\nNEW_COOKIE_SECRET=$(openssl rand -base64 32)\n\n# Update secret\nkubectl patch secret oauth2-proxy-secret -n auth \\\n  -p \"{\\\"stringData\\\":{\\\"cookie-secret\\\":\\\"$NEW_COOKIE_SECRET\\\"}}\"\n\n# Restart oauth2-proxy\nkubectl rollout restart deployment/oauth2-proxy -n auth\n</code></pre> <p>Warning: This invalidates all existing sessions. Users will need to re-authenticate.</p>"},{"location":"SETUP/#troubleshooting","title":"Troubleshooting","text":""},{"location":"SETUP/#issue-oauth2-proxy-pods-not-starting","title":"Issue: oauth2-proxy pods not starting","text":"<p>Check: <pre><code>kubectl describe pod -n auth -l app=oauth2-proxy\nkubectl logs -n auth -l app=oauth2-proxy\n</code></pre></p> <p>Common causes: - Invalid OAuth credentials - Missing secret - Resource constraints</p> <p>Fix: <pre><code># Verify secret exists\nkubectl get secret -n auth oauth2-proxy-secret\n\n# Check secret values\nkubectl get secret -n auth oauth2-proxy-secret -o yaml\n</code></pre></p>"},{"location":"SETUP/#issue-503-service-unavailable","title":"Issue: 503 Service Unavailable","text":"<p>Possible causes: 1. oauth2-proxy is down 2. EnvoyFilter misconfiguration 3. Backend service unavailable</p> <p>Check: <pre><code># Check oauth2-proxy health\nkubectl get pods -n auth -l app=oauth2-proxy\n\n# Test auth endpoint directly\nkubectl run -it --rm debug --image=curlimages/curl --restart=Never -- \\\n  curl -v http://oauth2-proxy.auth.svc.cluster.local:4180/ping\n\n# Check EnvoyFilter\nkubectl get envoyfilter -n istio-system ext-authz -o yaml\n</code></pre></p>"},{"location":"SETUP/#issue-redirect-loop","title":"Issue: Redirect loop","text":"<p>Possible causes: 1. Callback URL mismatch 2. Cookie domain mismatch 3. Invalid OAuth configuration</p> <p>Check: <pre><code># Verify callback URL in OAuth app matches\necho \"Should be: https://auth.cat-herding.net/oauth2/callback\"\n\n# Check oauth2-proxy config\nkubectl get deployment -n auth oauth2-proxy -o yaml | grep -A 5 \"args:\"\n\n# Check logs for errors\nkubectl logs -n auth -l app=oauth2-proxy | grep -i error\n</code></pre></p>"},{"location":"SETUP/#issue-tls-certificate-errors","title":"Issue: TLS certificate errors","text":"<p>Check: <pre><code># Verify certificate exists\nkubectl get secret -n istio-system cat-herding-wildcard-tls\n\n# Check certificate status (if using cert-manager)\nkubectl get certificate -n istio-system\n\n# View certificate details\nkubectl get secret -n istio-system cat-herding-wildcard-tls \\\n  -o jsonpath='{.data.tls\\.crt}' | base64 -d | openssl x509 -noout -text\n</code></pre></p>"},{"location":"SETUP/#issue-dns-not-resolving","title":"Issue: DNS not resolving","text":"<p>Check: <pre><code># Test DNS\nnslookup auth.cat-herding.net\nnslookup example-app.cat-herding.net\n\n# Verify ingress IP\nkubectl get svc -n istio-system istio-ingressgateway\n\n# Check if LoadBalancer has external IP\n</code></pre></p>"},{"location":"SETUP/#issue-authentication-works-but-user-headers-not-appearing","title":"Issue: Authentication works but user headers not appearing","text":"<p>Check: <pre><code># Verify EnvoyFilter includes headers\nkubectl get envoyfilter -n istio-system ext-authz -o yaml\n\n# Look for allowed_upstream_headers section\n\n# Check oauth2-proxy config includes header forwarding\nkubectl get deployment -n auth oauth2-proxy -o yaml | \\\n  grep -i \"set-xauthrequest\\|pass-user-headers\"\n</code></pre></p> <p>Test: <pre><code># Deploy a debug pod that echoes headers\nkubectl run echo --image=ealen/echo-server:latest -n example-app\n\n# Access it through the auth gateway and check headers\n</code></pre></p>"},{"location":"SETUP/#uninstall","title":"Uninstall","text":"<p>To remove the authentication infrastructure:</p> <pre><code># Remove example app\nkubectl delete -k k8s/apps/example-app/\n\n# Remove Istio configuration\nkubectl delete -f k8s/base/istio/\n\n# Remove oauth2-proxy\nkubectl delete -f k8s/base/oauth2-proxy/\nkubectl delete -f k8s/base/rbac/\n\n# Remove namespace\nkubectl delete -f k8s/base/namespace.yaml\n\n# Optional: Remove TLS certificate\nkubectl delete certificate -n istio-system cat-herding-wildcard\nkubectl delete secret -n istio-system cat-herding-wildcard-tls\n</code></pre>"},{"location":"SETUP/#next-steps","title":"Next Steps","text":"<ul> <li>Read ADDING_APPS.md for app integration guide</li> <li>Review ARCHITECTURE.md for detailed architecture</li> <li>Set up monitoring and alerting</li> <li>Configure additional OAuth providers</li> <li>Implement centralized logging</li> </ul>"},{"location":"SETUP/#support","title":"Support","text":"<p>For issues or questions: 1. Check ARCHITECTURE.md for design details 2. Review ADDING_APPS.md for app integration 3. Check oauth2-proxy logs: <code>kubectl logs -n auth -l app=oauth2-proxy</code> 4. Verify Istio config: <code>kubectl get envoyfilter,gateway,virtualservice -n istio-system</code></p>"},{"location":"SETUP/#references","title":"References","text":"<ul> <li>OAuth2 Proxy Configuration</li> <li>Istio External Authorization</li> <li>cert-manager Documentation</li> <li>GitHub OAuth Apps</li> </ul>"},{"location":"configuration/","title":"Configuration Guide","text":"<p>This document explains all configuration options available for the OAuth2 Sidecar Helm chart.</p> <p>For the full default <code>values.yaml</code>, see <code>helm/oauth2-sidecar/values.yaml</code>.</p>"},{"location":"configuration/#top-level-settings","title":"Top-Level Settings","text":""},{"location":"configuration/#domain","title":"<code>domain</code>","text":"<ul> <li>Type: string</li> <li>Default: <code>example.com</code></li> <li>Description: Base domain for your applications.</li> </ul>"},{"location":"configuration/#cookiedomain","title":"<code>cookieDomain</code>","text":"<ul> <li>Type: string</li> <li>Default: <code>.example.com</code></li> <li>Description: Cookie domain enabling SSO across subdomains.</li> </ul>"},{"location":"configuration/#oauth-oauth-provider-configuration","title":"<code>oauth</code> (OAuth Provider Configuration)","text":""},{"location":"configuration/#oauthprovider","title":"<code>oauth.provider</code>","text":"<ul> <li>Type: string</li> <li>Required: yes</li> <li>Values: <code>github</code>, <code>google</code>, <code>azure</code>, <code>oidc</code></li> <li>Description: Which OAuth2 provider to use.</li> </ul>"},{"location":"configuration/#oauthclientid","title":"<code>oauth.clientID</code>","text":"<ul> <li>Type: string</li> <li>Required: yes (unless <code>existingSecret</code> is used)</li> </ul>"},{"location":"configuration/#oauthclientsecret","title":"<code>oauth.clientSecret</code>","text":"<ul> <li>Type: string</li> <li>Required: yes (unless <code>existingSecret</code> is used)</li> </ul>"},{"location":"configuration/#oauthcookiesecret","title":"<code>oauth.cookieSecret</code>","text":"<ul> <li>Type: string</li> <li>Required: recommended (auto-generated if empty, but not suitable for long-term production)</li> <li>Description: Secret for encrypting session cookies.</li> </ul>"},{"location":"configuration/#oauthexistingsecret","title":"<code>oauth.existingSecret</code>","text":"<ul> <li>Type: string</li> <li>Description: Name of an existing secret containing:</li> <li><code>client-id</code></li> <li><code>client-secret</code></li> <li><code>cookie-secret</code></li> </ul>"},{"location":"configuration/#oauthgithub","title":"<code>oauth.github.*</code>","text":"<ul> <li><code>org</code>: Restrict access to a GitHub organization</li> <li><code>team</code>: Restrict access to a GitHub team</li> </ul>"},{"location":"configuration/#oauthgoogle","title":"<code>oauth.google.*</code>","text":"<ul> <li><code>hostedDomain</code>: Restrict access to a Google Workspace domain</li> </ul>"},{"location":"configuration/#oauthazure","title":"<code>oauth.azure.*</code>","text":"<ul> <li><code>tenant</code>: Azure AD tenant ID</li> <li><code>resource</code>: Optional custom resource/audience</li> </ul>"},{"location":"configuration/#oauthoidc","title":"<code>oauth.oidc.*</code>","text":"<ul> <li><code>issuerURL</code>: OIDC issuer URL</li> <li><code>extraScopes</code>: Additional scopes to request</li> </ul>"},{"location":"configuration/#istio-istio-integration","title":"<code>istio</code> (Istio Integration)","text":""},{"location":"configuration/#istioenabled","title":"<code>istio.enabled</code>","text":"<ul> <li>Type: bool</li> <li>Default: <code>true</code></li> <li>Description: Enable Istio-specific resources.</li> </ul>"},{"location":"configuration/#istiogatewaycreate","title":"<code>istio.gateway.create</code>","text":"<ul> <li>Type: bool</li> <li>Default: <code>true</code></li> <li>Description: Create an Istio Gateway resource.</li> </ul>"},{"location":"configuration/#istiogatewayexistinggateway","title":"<code>istio.gateway.existingGateway</code>","text":"<ul> <li>Type: string</li> <li>Description: Use an existing gateway instead of creating one.</li> </ul>"},{"location":"configuration/#istiogatewaytls","title":"<code>istio.gateway.tls.*</code>","text":"<ul> <li><code>credentialName</code>: Name of TLS secret</li> <li><code>mode</code>: TLS mode (e.g. <code>SIMPLE</code>)</li> <li><code>minProtocolVersion</code>: Minimum TLS version (<code>TLSV1_2</code>)</li> </ul>"},{"location":"configuration/#istioingressgateway","title":"<code>istio.ingressGateway.*</code>","text":"<ul> <li><code>selector</code>: Label selector for Istio ingress gateway</li> <li><code>namespace</code>: Namespace of ingress gateway</li> </ul>"},{"location":"configuration/#sidecar-oauth2-proxy-sidecar","title":"<code>sidecar</code> (OAuth2 Proxy Sidecar)","text":""},{"location":"configuration/#sidecarimage","title":"<code>sidecar.image.*</code>","text":"<ul> <li><code>repository</code>: Container image repository</li> <li><code>tag</code>: Image tag</li> <li><code>pullPolicy</code>: Image pull policy</li> </ul>"},{"location":"configuration/#sidecarresources","title":"<code>sidecar.resources.*</code>","text":"<ul> <li>Kubernetes resource requests and limits.</li> </ul>"},{"location":"configuration/#sidecarport","title":"<code>sidecar.port</code>","text":"<ul> <li>Default: <code>4180</code></li> <li>Description: Port where oauth2-proxy listens.</li> </ul>"},{"location":"configuration/#sidecarupstreamport","title":"<code>sidecar.upstreamPort</code>","text":"<ul> <li>Default: <code>8080</code></li> <li>Description: Port of your application inside the pod.</li> </ul>"},{"location":"configuration/#sidecarsecuritycontext","title":"<code>sidecar.securityContext.*</code>","text":"<ul> <li>Preconfigured for least privilege and non-root execution.</li> </ul>"},{"location":"configuration/#sidecarlivenessprobe-sidecarreadinessprobe","title":"<code>sidecar.livenessProbe</code> / <code>sidecar.readinessProbe</code>","text":"<ul> <li>Health checks for oauth2-proxy.</li> </ul>"},{"location":"configuration/#session-session-cookies","title":"<code>session</code> (Session &amp; Cookies)","text":""},{"location":"configuration/#sessioncookieexpire","title":"<code>session.cookieExpire</code>","text":"<ul> <li>Default: <code>168h</code></li> <li>Description: Session cookie expiry duration.</li> </ul>"},{"location":"configuration/#sessioncookierefresh","title":"<code>session.cookieRefresh</code>","text":"<ul> <li>Default: <code>1h</code></li> <li>Description: How often to refresh session.</li> </ul>"},{"location":"configuration/#sessioncookiename","title":"<code>session.cookieName</code>","text":"<ul> <li>Default: <code>_oauth2_proxy</code></li> </ul>"},{"location":"configuration/#sessioncookiesecure","title":"<code>session.cookieSecure</code>","text":"<ul> <li>Default: <code>true</code></li> </ul>"},{"location":"configuration/#sessioncookiehttponly","title":"<code>session.cookieHttpOnly</code>","text":"<ul> <li>Default: <code>true</code></li> </ul>"},{"location":"configuration/#sessioncookiesamesite","title":"<code>session.cookieSameSite</code>","text":"<ul> <li>Default: <code>lax</code></li> </ul>"},{"location":"configuration/#email-emaildomain-restrictions","title":"<code>email</code> (Email/Domain Restrictions)","text":""},{"location":"configuration/#emaildomains","title":"<code>email.domains</code>","text":"<ul> <li>Default: <code>['*']</code></li> <li>Description: Allowed email domains. Set to specific domains to restrict access.</li> </ul>"},{"location":"configuration/#customtemplates","title":"<code>customTemplates</code>","text":""},{"location":"configuration/#customtemplatesenabled","title":"<code>customTemplates.enabled</code>","text":"<ul> <li>Default: <code>true</code></li> <li>Description: Enable custom branding for sign-in and error pages.</li> </ul>"},{"location":"configuration/#customtemplatesbrandname","title":"<code>customTemplates.brandName</code>","text":"<ul> <li>Default: <code>\"SSO Portal\"</code></li> </ul>"},{"location":"configuration/#customtemplateslogo","title":"<code>customTemplates.logo</code>","text":"<ul> <li>Default: empty</li> <li>Description: Base64-encoded logo.</li> </ul>"},{"location":"configuration/#namespace","title":"<code>namespace</code>","text":"<ul> <li>Default: <code>default</code></li> <li>Description: Namespace where resources are deployed.</li> </ul>"},{"location":"configuration/#advanced-settings","title":"Advanced Settings","text":"<ul> <li><code>extraArgs</code>: Additional oauth2-proxy arguments</li> <li><code>configMapName</code>, <code>secretName</code>, <code>templatesConfigMapName</code>: Override resource names</li> <li><code>serviceAccount.*</code>: Configure service account</li> <li><code>podAnnotations</code>, <code>podLabels</code>: Additional metadata</li> <li><code>nodeSelector</code>, <code>tolerations</code>, <code>affinity</code>: Scheduling controls</li> </ul> <p>For detailed examples, see the <code>examples/</code> directory and provider-specific docs in <code>docs/providers/</code>.</p>"},{"location":"contributing/","title":"Contributing to OAuth2 Sidecar Proxy","text":"<p>Thank you for your interest in contributing! This document provides guidelines for contributing to the project.</p>"},{"location":"contributing/#code-of-conduct","title":"Code of Conduct","text":"<p>Be respectful and inclusive. We welcome contributions from everyone.</p>"},{"location":"contributing/#how-to-contribute","title":"How to Contribute","text":""},{"location":"contributing/#reporting-bugs","title":"Reporting Bugs","text":"<ol> <li>Check if the bug is already reported in Issues</li> <li>If not, create a new issue with:</li> <li>Clear title and description</li> <li>Steps to reproduce</li> <li>Expected vs actual behavior</li> <li>Environment details (K8s version, Istio version, etc.)</li> <li>Relevant logs</li> </ol>"},{"location":"contributing/#suggesting-enhancements","title":"Suggesting Enhancements","text":"<ol> <li>Check existing Issues and Discussions</li> <li>Create a new discussion or issue describing:</li> <li>The problem you're trying to solve</li> <li>Your proposed solution</li> <li>Any alternatives you've considered</li> </ol>"},{"location":"contributing/#pull-requests","title":"Pull Requests","text":"<ol> <li>Fork the repository</li> <li>Create a feature branch (<code>git checkout -b feature/amazing-feature</code>)</li> <li>Make your changes</li> <li>Test your changes thoroughly</li> <li>Update documentation if needed</li> <li>Commit with clear messages</li> <li>Push to your fork</li> <li>Open a Pull Request</li> </ol>"},{"location":"contributing/#pr-guidelines","title":"PR Guidelines","text":"<ul> <li>Follow existing code style</li> <li>Include tests if adding features</li> <li>Update documentation</li> <li>Keep PRs focused - one feature/fix per PR</li> <li>Reference related issues</li> </ul>"},{"location":"contributing/#development-setup","title":"Development Setup","text":""},{"location":"contributing/#prerequisites","title":"Prerequisites","text":"<ul> <li>Kubernetes cluster (kind, minikube, or cloud)</li> <li>kubectl</li> <li>Helm 3</li> <li>Docker</li> </ul>"},{"location":"contributing/#local-development","title":"Local Development","text":"<pre><code># Clone the repo\ngit clone https://github.com/ianlintner/authproxy.git\ncd authproxy\n\n# Install MkDocs for documentation\npip install -r docs/requirements.txt\n\n# Serve documentation locally\nmkdocs serve\n\n# Test Kubernetes manifests\n./scripts/validate.sh\n</code></pre>"},{"location":"contributing/#documentation","title":"Documentation","text":"<p>We use MkDocs with Material theme. Documentation is in the <code>docs/</code> directory.</p> <pre><code># Install dependencies\npip install -r docs/requirements.txt\n\n# Serve locally\nmkdocs serve\n\n# Build\nmkdocs build\n</code></pre>"},{"location":"contributing/#documentation-guidelines","title":"Documentation Guidelines","text":"<ul> <li>Use clear, concise language</li> <li>Include code examples</li> <li>Add Mermaid diagrams for complex concepts</li> <li>Test all commands and examples</li> <li>Use admonitions for important notes</li> </ul>"},{"location":"contributing/#testing","title":"Testing","text":"<p>Before submitting a PR:</p> <pre><code># Validate Kubernetes manifests\nkubectl apply --dry-run=client -k k8s/base/\nkubectl apply --dry-run=client -k k8s/apps/example-app/\n\n# Test Helm chart\nhelm lint helm/oauth2-sidecar/\nhelm template oauth2-sidecar helm/oauth2-sidecar/ --values examples/simple-app/values.yaml\n\n# Run validation script\n./scripts/validate.sh\n</code></pre>"},{"location":"contributing/#helm-chart-development","title":"Helm Chart Development","text":"<p>When modifying the Helm chart:</p> <ol> <li>Update version in <code>Chart.yaml</code></li> <li>Update <code>values.yaml</code> with new options</li> <li>Document changes in chart README</li> <li>Test with different value combinations</li> <li>Run <code>helm lint</code></li> </ol>"},{"location":"contributing/#project-structure","title":"Project Structure","text":"<pre><code>\u251c\u2500\u2500 docs/                   # MkDocs documentation\n\u251c\u2500\u2500 helm/oauth2-sidecar/   # Helm chart\n\u251c\u2500\u2500 k8s/                   # Kubernetes manifests\n\u2502   \u251c\u2500\u2500 base/             # Base resources\n\u2502   \u2514\u2500\u2500 apps/             # Example apps\n\u251c\u2500\u2500 scripts/              # Helper scripts\n\u2514\u2500\u2500 examples/             # Example configurations\n</code></pre>"},{"location":"contributing/#commit-message-guidelines","title":"Commit Message Guidelines","text":"<p>Use clear, descriptive commit messages:</p> <pre><code>type(scope): brief description\n\nDetailed explanation of what changed and why.\n\nFixes #123\n</code></pre> <p>Types: - <code>feat</code>: New feature - <code>fix</code>: Bug fix - <code>docs</code>: Documentation changes - <code>style</code>: Code style changes (formatting) - <code>refactor</code>: Code refactoring - <code>test</code>: Adding tests - <code>chore</code>: Maintenance tasks</p> <p>Examples: <pre><code>feat(helm): add support for custom OAuth scopes\nfix(sidecar): correct redirect URL environment variable\ndocs(quickstart): add Google OAuth setup instructions\n</code></pre></p>"},{"location":"contributing/#release-process","title":"Release Process","text":"<p>Maintainers will:</p> <ol> <li>Update version in relevant files</li> <li>Update CHANGELOG</li> <li>Create git tag</li> <li>Build and push Helm chart</li> <li>Update documentation</li> <li>Create GitHub release</li> </ol>"},{"location":"contributing/#questions","title":"Questions?","text":"<ul> <li>Discussions: GitHub Discussions</li> <li>Issues: GitHub Issues</li> </ul>"},{"location":"contributing/#license","title":"License","text":"<p>By contributing, you agree that your contributions will be licensed under the MIT License.</p>"},{"location":"migration/","title":"Migration Guide","text":"<p>Migrating from centralized oauth2-proxy to the sidecar pattern.</p>"},{"location":"migration/#overview","title":"Overview","text":"<p>This guide helps you migrate from a centralized oauth2-proxy deployment (with Istio ext_authz) to the sidecar pattern.</p> <pre><code>graph TB\n    subgraph \"Before: Centralized\"\n        A[Istio Gateway] --&gt; B[ext_authz filter]\n        B --&gt; C[oauth2-proxy service]\n        C --&gt; D[App 1]\n        C --&gt; E[App 2]\n        C --&gt; F[App 3]\n    end\n\n    subgraph \"After: Sidecar\"\n        G[Istio Gateway] --&gt; H[App 1 + sidecar]\n        G --&gt; I[App 2 + sidecar]\n        G --&gt; J[App 3 + sidecar]\n    end\n\n    style C fill:#ef4444,stroke:#333,stroke-width:2px,color:#fff\n    style H fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n    style I fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n    style J fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n</code></pre>"},{"location":"migration/#benefits-of-migration","title":"Benefits of Migration","text":"<ul> <li>\u2705 Simpler architecture - No ext_authz configuration</li> <li>\u2705 Better isolation - Each app's auth is independent</li> <li>\u2705 Easier debugging - Logs co-located with application</li> <li>\u2705 More flexible - Different OAuth providers per app</li> <li>\u2705 More portable - Apps can move between clusters</li> </ul>"},{"location":"migration/#migration-steps","title":"Migration Steps","text":""},{"location":"migration/#1-install-new-infrastructure","title":"1. Install New Infrastructure","text":"<p>Install the sidecar-based infrastructure alongside the old one:</p> <pre><code>helm install oauth2-sidecar ./helm/oauth2-sidecar \\\n  --values migration-values.yaml\n</code></pre>"},{"location":"migration/#2-migrate-applications-one-by-one","title":"2. Migrate Applications One by One","text":"<p>For each application:</p> <ol> <li>Add oauth2-proxy sidecar to deployment</li> <li>Update service to port 4180</li> <li>Create new VirtualService (or update existing)</li> <li>Deploy and test</li> <li>Remove old VirtualService/routes</li> </ol>"},{"location":"migration/#3-remove-centralized-infrastructure","title":"3. Remove Centralized Infrastructure","text":"<p>Once all apps are migrated:</p> <pre><code># Remove ext_authz filter\nkubectl delete envoyfilter ext-authz-filter\n\n# Remove centralized oauth2-proxy\nkubectl delete deployment oauth2-proxy\nkubectl delete service oauth2-proxy\n\n# Remove authorization policies\nkubectl delete authorizationpolicy oauth2-proxy-*\n</code></pre>"},{"location":"migration/#detailed-migration-example","title":"Detailed Migration Example","text":""},{"location":"migration/#before-centralized-setup","title":"Before: Centralized Setup","text":"<pre><code># EnvoyFilter with ext_authz\napiVersion: networking.istio.io/v1alpha3\nkind: EnvoyFilter\nmetadata:\n  name: ext-authz-filter\nspec:\n  workloadSelector:\n    labels:\n      istio: ingressgateway\n  configPatches:\n  - applyTo: HTTP_FILTER\n    match:\n      context: GATEWAY\n      listener:\n        filterChain:\n          filter:\n            name: \"envoy.filters.network.http_connection_manager\"\n            subFilter:\n              name: \"envoy.filters.http.router\"\n    patch:\n      operation: INSERT_BEFORE\n      value:\n        name: envoy.filters.http.ext_authz\n        typed_config:\n          \"@type\": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz\n          http_service:\n            server_uri:\n              uri: http://oauth2-proxy.default.svc.cluster.local:4180\n              cluster: outbound|4180||oauth2-proxy.default.svc.cluster.local\n              timeout: 10s\n</code></pre>"},{"location":"migration/#after-sidecar-setup","title":"After: Sidecar Setup","text":"<pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: myapp\nspec:\n  template:\n    spec:\n      containers:\n      # oauth2-proxy sidecar\n      - name: oauth2-proxy\n        image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0\n        ports:\n        - containerPort: 4180\n        env:\n        - name: OAUTH2_PROXY_REDIRECT_URL\n          value: \"https://myapp.example.com/oauth2/callback\"\n        - name: OAUTH2_PROXY_UPSTREAMS\n          value: \"http://127.0.0.1:8080\"\n        # ... credentials from secret\n\n      # Your app\n      - name: myapp\n        image: myapp:latest\n        ports:\n        - containerPort: 8080\n</code></pre>"},{"location":"migration/#configuration-mapping","title":"Configuration Mapping","text":""},{"location":"migration/#centralized-configuration","title":"Centralized Configuration","text":"<p>In centralized setup, configuration was in: - EnvoyFilter spec - oauth2-proxy deployment env vars - Shared ConfigMap</p>"},{"location":"migration/#sidecar-configuration","title":"Sidecar Configuration","text":"<p>In sidecar setup, configuration is in: - Shared ConfigMap (common settings) - Per-deployment env vars (app-specific)</p> Setting Centralized Sidecar Provider Deployment env ConfigMap Client ID/Secret Secret Secret (same) Redirect URL Per-route Per-pod env Cookie domain ConfigMap ConfigMap Upstream URL EnvoyFilter Per-pod env"},{"location":"migration/#testing-migration","title":"Testing Migration","text":"<p>Test each application after migration:</p> <pre><code># 1. Check pod is running\nkubectl get pods -l app=myapp\n\n# 2. Check both containers are ready\nkubectl get pod myapp-xxx -o jsonpath='{.status.containerStatuses[*].ready}'\n\n# 3. Test authentication\ncurl -v https://myapp.example.com/\n# Should redirect to OAuth provider\n\n# 4. Check logs\nkubectl logs myapp-xxx -c oauth2-proxy\nkubectl logs myapp-xxx -c myapp\n</code></pre>"},{"location":"migration/#rollback-plan","title":"Rollback Plan","text":"<p>If issues occur, you can rollback:</p> <pre><code># 1. Scale down new deployment\nkubectl scale deployment myapp --replicas=0\n\n# 2. Route traffic back to old setup\nkubectl apply -f old-virtualservice.yaml\n\n# 3. Verify old setup works\ncurl https://myapp.example.com/\n</code></pre>"},{"location":"migration/#common-migration-issues","title":"Common Migration Issues","text":""},{"location":"migration/#issue-503-errors","title":"Issue: 503 Errors","text":"<p>Cause: VirtualService routing to wrong port</p> <p>Fix: Ensure VirtualService routes to port 4180:</p> <pre><code>http:\n- route:\n  - destination:\n      host: myapp\n      port:\n        number: 4180  # Not 8080!\n</code></pre>"},{"location":"migration/#issue-redirect-loop","title":"Issue: Redirect Loop","text":"<p>Cause: Incorrect redirect URL or cookie domain</p> <p>Fix: Verify environment variables: <pre><code>- name: OAUTH2_PROXY_REDIRECT_URL\n  value: \"https://myapp.example.com/oauth2/callback\"  # Must match domain\n- name: OAUTH2_PROXY_COOKIE_DOMAIN\n  value: \".example.com\"  # Leading dot for subdomains\n</code></pre></p>"},{"location":"migration/#issue-sso-not-working","title":"Issue: SSO Not Working","text":"<p>Cause: Different cookie domains between apps</p> <p>Fix: All apps must use same cookie domain in ConfigMap.</p>"},{"location":"migration/#cleanup-checklist","title":"Cleanup Checklist","text":"<p>After successful migration:</p> <ul> <li> All applications migrated to sidecar pattern</li> <li> All applications tested and working</li> <li> Traffic verified on new setup</li> <li> Old EnvoyFilter removed</li> <li> Old oauth2-proxy deployment removed</li> <li> Old services removed</li> <li> Old authorization policies removed</li> <li> Documentation updated</li> </ul>"},{"location":"migration/#next-steps","title":"Next Steps","text":"<ul> <li>Configure custom templates</li> <li>Set up monitoring</li> <li>Review security settings</li> </ul>"},{"location":"security/","title":"Security Best Practices","text":"<p>Guidelines for running OAuth2 Sidecar in production.</p>"},{"location":"security/#1-secrets-management","title":"1. Secrets Management","text":"<ul> <li>Never commit client IDs/secrets to Git.</li> <li>Use Kubernetes Secrets or an external secret manager.</li> <li>Rotate <code>cookieSecret</code> regularly.</li> </ul>"},{"location":"security/#2-tls","title":"2. TLS","text":"<ul> <li>Always terminate TLS at the Istio Gateway.</li> <li>Use strong ciphers and TLS 1.2+.</li> <li>Automate certificate renewal (e.g. cert-manager).</li> </ul>"},{"location":"security/#3-least-privilege","title":"3. Least Privilege","text":"<ul> <li>Keep the oauth2-proxy sidecar running as non-root (default in this chart).</li> <li>Do not grant unnecessary RBAC permissions.</li> </ul>"},{"location":"security/#4-session-security","title":"4. Session Security","text":"<ul> <li>Keep <code>cookieSecure: true</code> in production.</li> <li>Use <code>SameSite=lax</code> or <code>Strict</code> where possible.</li> <li>Set reasonable session expiry and refresh intervals.</li> </ul>"},{"location":"security/#5-provider-configuration","title":"5. Provider Configuration","text":"<ul> <li>Limit access via:</li> <li>GitHub org/team</li> <li>Google Workspace domain</li> <li>Azure AD tenant</li> <li>Request only required scopes.</li> </ul>"},{"location":"security/#6-logging-monitoring","title":"6. Logging &amp; Monitoring","text":"<ul> <li>Enable access logs for oauth2-proxy.</li> <li>Monitor 4xx/5xx rates and login failures.</li> <li>Use tools like Prometheus/Grafana for metrics.</li> </ul>"},{"location":"security/#7-multi-tenancy","title":"7. Multi-Tenancy","text":"<ul> <li>Use separate client IDs/secrets per tenant if needed.</li> <li>Isolate apps by namespace.</li> </ul>"},{"location":"security/#8-supply-chain","title":"8. Supply Chain","text":"<ul> <li>Pin image tags (no <code>:latest</code>).</li> <li>Use trusted registries.</li> <li>Scan images for vulnerabilities.</li> </ul>"},{"location":"security/#9-backup-recovery","title":"9. Backup &amp; Recovery","text":"<ul> <li>Backup configuration (Helm values, manifests).</li> <li>Be prepared to roll back via <code>helm rollback</code>.</li> </ul>"},{"location":"security/#10-regular-reviews","title":"10. Regular Reviews","text":"<ul> <li>Periodically review:</li> <li>Provider app registrations</li> <li>RBAC roles</li> <li>Network policies</li> </ul>"},{"location":"troubleshooting/","title":"Troubleshooting","text":"<p>Common issues and how to diagnose/fix them.</p>"},{"location":"troubleshooting/#1-403-forbidden-from-istiogateway","title":"1. 403 Forbidden from Istio/Gateway","text":""},{"location":"troubleshooting/#symptoms","title":"Symptoms","text":"<ul> <li><code>curl -I https://my-app.example.com</code> returns <code>HTTP/2 403</code></li> <li>Browser shows generic 403 page</li> </ul>"},{"location":"troubleshooting/#causes","title":"Causes","text":"<ul> <li>AuthorizationPolicy blocking traffic</li> <li>VirtualService routing to wrong service/port</li> </ul>"},{"location":"troubleshooting/#checks","title":"Checks","text":"<pre><code>kubectl get authorizationpolicy -A\nkubectl get virtualservice -A\nkubectl describe virtualservice my-app -n default\n</code></pre> <p>Ensure your VirtualService routes to the service backing the oauth2-proxy sidecar (port 4180).</p>"},{"location":"troubleshooting/#2-redirect-loop","title":"2. Redirect Loop","text":""},{"location":"troubleshooting/#symptoms_1","title":"Symptoms","text":"<ul> <li>Browser keeps redirecting between your app and OAuth provider</li> </ul>"},{"location":"troubleshooting/#causes_1","title":"Causes","text":"<ul> <li>Cookie domain mismatch</li> <li>Wrong redirect URL</li> </ul>"},{"location":"troubleshooting/#checks_1","title":"Checks","text":"<ul> <li><code>cookieDomain</code> must start with <code>.</code> and match your domain</li> <li><code>OAUTH2_PROXY_REDIRECT_URL</code> must match the callback URL configured in your provider</li> </ul>"},{"location":"troubleshooting/#3-login-page-not-using-custom-branding","title":"3. Login Page Not Using Custom Branding","text":""},{"location":"troubleshooting/#symptoms_2","title":"Symptoms","text":"<ul> <li>Default oauth2-proxy login page appears</li> </ul>"},{"location":"troubleshooting/#causes_2","title":"Causes","text":"<ul> <li>Custom templates ConfigMap not mounted</li> <li><code>customTemplates.enabled</code> set to <code>false</code></li> </ul>"},{"location":"troubleshooting/#checks_2","title":"Checks","text":"<pre><code>kubectl get configmap oauth2-proxy-templates\nkubectl describe pod &lt;pod&gt; | grep oauth2-proxy-templates\n</code></pre>"},{"location":"troubleshooting/#4-500-error-from-oauth2-proxy","title":"4. 500 Error from oauth2-proxy","text":""},{"location":"troubleshooting/#symptoms_3","title":"Symptoms","text":"<ul> <li>Error page from oauth2-proxy</li> </ul>"},{"location":"troubleshooting/#checks_3","title":"Checks","text":"<pre><code>kubectl logs deployment/my-app -c oauth2-proxy\n</code></pre> <p>Look for: - Misconfigured provider settings - Invalid client ID/secret</p>"},{"location":"troubleshooting/#5-users-from-wrong-domain-can-log-in","title":"5. Users from Wrong Domain Can Log In","text":""},{"location":"troubleshooting/#causes_3","title":"Causes","text":"<ul> <li>Email/domain restrictions not configured</li> </ul>"},{"location":"troubleshooting/#fix","title":"Fix","text":"<ul> <li>For Google: set <code>oauth.google.hostedDomain</code></li> <li>For GitHub: set <code>oauth.github.org</code> and/or <code>oauth.github.team</code></li> <li>For generic: use <code>email.domains</code> filters</li> </ul>"},{"location":"troubleshooting/#6-tlscertificate-issues","title":"6. TLS/Certificate Issues","text":"<p>If creating a new Istio Gateway with the chart:</p> <ul> <li>Ensure <code>istio.gateway.tls.credentialName</code> points to a valid TLS secret</li> <li>Secret must be in the same namespace as the gateway</li> </ul>"},{"location":"troubleshooting/#7-verifying-headers-in-your-app","title":"7. Verifying Headers in Your App","text":"<p>To debug what headers your app receives, add an endpoint that dumps headers:</p> <pre><code>curl -s https://my-app.example.com/headers\n</code></pre> <p>Your app should log or return headers like: - <code>X-Auth-Request-User</code> - <code>X-Auth-Request-Email</code> - <code>X-Forwarded-User</code></p>"},{"location":"troubleshooting/#8-still-stuck","title":"8. Still Stuck?","text":"<p>Collect the following before asking for help: - <code>helm get values oauth2-sidecar -n &lt;ns&gt;</code> - <code>kubectl get pods,svc,virtualservice,authorizationpolicy -n &lt;ns&gt;</code> - Logs from oauth2-proxy sidecar container</p>"},{"location":"architecture/overview/","title":"Architecture Overview","text":"<p>Understanding the OAuth2 Sidecar Proxy architecture and design decisions.</p>"},{"location":"architecture/overview/#design-philosophy","title":"Design Philosophy","text":"<p>The OAuth2 Sidecar Proxy is built on three core principles:</p> <ol> <li>Simplicity: Avoid complex centralized authentication services</li> <li>Isolation: Each application manages its own authentication lifecycle</li> <li>Portability: Applications can easily move between clusters</li> </ol>"},{"location":"architecture/overview/#high-level-architecture","title":"High-Level Architecture","text":"<pre><code>graph TB\n    subgraph Internet\n        A[Users]\n    end\n\n    subgraph Azure Load Balancer\n        B[Public IP]\n    end\n\n    subgraph Istio Ingress\n        C[Gateway*.example.com]\n        D[VirtualService]\n    end\n\n    subgraph Kubernetes Cluster\n        E[Service:4180]\n\n        subgraph Pod\n            F[oauth2-proxy:4180]\n            G[Application:8080]\n        end\n    end\n\n    subgraph OAuth Provider\n        H[GitHub/Google/Azure AD]\n    end\n\n    A --&gt;|HTTPS| B\n    B --&gt; C\n    C --&gt; D\n    D --&gt; E\n    E --&gt; F\n    F --&gt;|localhost| G\n    F -.-&gt;|OAuth Flow| H\n\n    style F fill:#4c51bf,stroke:#333,stroke-width:3px,color:#fff\n    style G fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n    style H fill:#f59e0b,stroke:#333,stroke-width:2px,color:#fff\n</code></pre>"},{"location":"architecture/overview/#components","title":"Components","text":""},{"location":"architecture/overview/#1-istio-ingress-gateway","title":"1. Istio Ingress Gateway","text":"<p>The entry point for all external traffic to your cluster.</p> <p>Responsibilities: - TLS termination using wildcard certificate - HTTP to HTTPS redirect - Route traffic to application services based on hostname</p> <p>Key Configuration: <pre><code>apiVersion: networking.istio.io/v1beta1\nkind: Gateway\nmetadata:\n  name: oauth2-gateway\nspec:\n  selector:\n    istio: ingressgateway\n  servers:\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    tls:\n      mode: SIMPLE\n      credentialName: wildcard-tls\n    hosts:\n    - \"*.example.com\"\n</code></pre></p>"},{"location":"architecture/overview/#2-virtualservice","title":"2. VirtualService","text":"<p>Routes traffic from the Gateway to your application service.</p> <p>Responsibilities: - Host-based routing (e.g., <code>app1.example.com</code> \u2192 <code>app1-service</code>) - Directs traffic to port 4180 (oauth2-proxy)</p> <pre><code>graph LR\n    A[Gateway] --&gt; B{VirtualService}\n    B --&gt;|app1.example.com| C[app1-service:4180]\n    B --&gt;|app2.example.com| D[app2-service:4180]\n    B --&gt;|app3.example.com| E[app3-service:4180]\n\n    style B fill:#4c51bf,stroke:#333,stroke-width:2px,color:#fff\n</code></pre>"},{"location":"architecture/overview/#3-service","title":"3. Service","text":"<p>Kubernetes service that exposes the oauth2-proxy port.</p> <p>Key Points: - Exposes port 4180 (not your app's port!) - Type: ClusterIP (internal only) - Routes to pods with matching labels</p>"},{"location":"architecture/overview/#4-pod-with-sidecar","title":"4. Pod with Sidecar","text":"<p>The core of the architecture: a pod containing both oauth2-proxy and your application.</p> <pre><code>graph TB\n    subgraph Pod\n        direction TB\n        A[Service Traffic:4180] --&gt; B[oauth2-proxy container:4180]\n        B --&gt;|Check Session| C{Authenticated?}\n        C --&gt;|No| D[Redirect toOAuth Provider]\n        C --&gt;|Yes| E[Proxy Request]\n        E --&gt; F[Applicationcontainer:8080]\n        F --&gt; G[Response]\n        G --&gt; B\n        B --&gt; H[Back to Client]\n    end\n\n    D -.-&gt;|OAuth Flow| I[GitHub/Google/etc]\n    I -.-&gt;|Callback| B\n\n    style B fill:#4c51bf,stroke:#333,stroke-width:2px,color:#fff\n    style F fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n    style I fill:#f59e0b,stroke:#333,stroke-width:2px,color:#fff\n</code></pre> <p>Container Details:</p> oauth2-proxy SidecarApplication Container <pre><code>- name: oauth2-proxy\n  image: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0\n  ports:\n  - containerPort: 4180\n  env:\n  - name: OAUTH2_PROXY_REDIRECT_URL\n    value: \"https://auth.example.com/oauth2/callback\"\n  - name: OAUTH2_PROXY_UPSTREAMS\n    value: \"http://127.0.0.1:8080\"\n  - name: OAUTH2_PROXY_CLIENT_ID\n    valueFrom:\n      secretKeyRef:\n        name: oauth2-proxy-secret\n        key: client-id\n  # ... more config\n</code></pre> <pre><code>- name: app\n  image: your-app:latest\n  ports:\n  - containerPort: 8080\n  # Your app listens on 8080\n  # Receives authenticated requests from oauth2-proxy\n  # Gets user info via headers\n</code></pre>"},{"location":"architecture/overview/#5-configuration","title":"5. Configuration","text":"<p>Two main configuration sources:</p> <p>ConfigMap - OAuth2 proxy settings: <pre><code>apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: oauth2-proxy-sidecar-config\ndata:\n  oauth2_proxy.cfg: |\n    provider = \"github\"\n    cookie_domains = [\".example.com\"]\n    skip_provider_button = false\n    custom_templates_dir = \"/templates\"\n    # ... more settings\n</code></pre></p> <p>Secret - Sensitive OAuth credentials: <pre><code>apiVersion: v1\nkind: Secret\nmetadata:\n  name: oauth2-proxy-secret\ntype: Opaque\ndata:\n  client-id: &lt;base64&gt;\n  client-secret: &lt;base64&gt;\n  cookie-secret: &lt;base64&gt;\n</code></pre></p>"},{"location":"architecture/overview/#authentication-flow","title":"Authentication Flow","text":""},{"location":"architecture/overview/#first-visit-not-authenticated","title":"First Visit (Not Authenticated)","text":"<pre><code>sequenceDiagram\n    autonumber\n    participant User\n    participant Istio\n    participant Sidecar as oauth2-proxy\n    participant App\n    participant Provider as OAuth Provider\n\n    User-&gt;&gt;Istio: GET https://app.example.com/\n    Istio-&gt;&gt;Sidecar: Forward request\n    Sidecar-&gt;&gt;Sidecar: Check for session cookie\n    Note over Sidecar: No valid cookie found\n    Sidecar--&gt;&gt;User: 200 OK (Sign-in page HTML)\n    User-&gt;&gt;Sidecar: Click provider button\n    Sidecar--&gt;&gt;User: 302 Redirect to OAuth provider\n    User-&gt;&gt;Provider: GET /authorize?client_id=...\n    Provider--&gt;&gt;User: Login page\n    User-&gt;&gt;Provider: Submit credentials\n    Provider--&gt;&gt;User: 302 Redirect /oauth2/callback?code=...\n    User-&gt;&gt;Sidecar: GET /oauth2/callback?code=...\n    Sidecar-&gt;&gt;Provider: POST /token (exchange code)\n    Provider--&gt;&gt;Sidecar: Access token + user info\n    Sidecar-&gt;&gt;Sidecar: Create session\n    Sidecar--&gt;&gt;User: 302 Set-Cookie + Redirect to /\n    User-&gt;&gt;Sidecar: GET / (with cookie)\n    Sidecar-&gt;&gt;Sidecar: Validate cookie\n    Sidecar-&gt;&gt;App: Proxy request + inject headers\n    App--&gt;&gt;Sidecar: Response\n    Sidecar--&gt;&gt;User: Response\n</code></pre>"},{"location":"architecture/overview/#subsequent-visits-authenticated","title":"Subsequent Visits (Authenticated)","text":"<pre><code>sequenceDiagram\n    autonumber\n    participant User\n    participant Istio\n    participant Sidecar as oauth2-proxy\n    participant App\n\n    User-&gt;&gt;Istio: GET / (with cookie)\n    Istio-&gt;&gt;Sidecar: Forward request\n    Sidecar-&gt;&gt;Sidecar: Validate session cookie\n    Note over Sidecar: Cookie valid!\n    Sidecar-&gt;&gt;App: Proxy to localhost:8080+ inject user headers\n    Note over App: X-Auth-Request-EmailX-Auth-Request-User...\n    App--&gt;&gt;Sidecar: Response\n    Sidecar--&gt;&gt;User: Response\n</code></pre>"},{"location":"architecture/overview/#single-sign-on-sso","title":"Single Sign-On (SSO)","text":"<p>SSO works by sharing the session cookie across all applications in your domain.</p> <pre><code>graph TB\n    subgraph Domain: .example.com\n        A[app1.example.com]\n        B[app2.example.com]\n        C[app3.example.com]\n    end\n\n    D[Shared Cookie_oauth2_proxyDomain: .example.com]\n\n    D -.-&gt;|Used by| A\n    D -.-&gt;|Used by| B\n    D -.-&gt;|Used by| C\n\n    E[User logs in once] --&gt; D\n\n    style D fill:#4c51bf,stroke:#333,stroke-width:2px,color:#fff\n    style E fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n</code></pre> <p>How it works:</p> <ol> <li>User authenticates to <code>app1.example.com</code></li> <li>Cookie is set with domain <code>.example.com</code></li> <li>User visits <code>app2.example.com</code></li> <li>Browser automatically sends the cookie</li> <li><code>app2</code> validates the cookie \u2713</li> <li>User is already authenticated!</li> </ol>"},{"location":"architecture/overview/#design-decisions","title":"Design Decisions","text":""},{"location":"architecture/overview/#why-sidecar-vs-centralized","title":"Why Sidecar vs. Centralized?","text":"Aspect Sidecar Pattern Centralized Service Configuration Simple per-app config Complex ext_authz setup Debugging Easy - logs with app Hard - distributed logs Isolation Each app independent Shared state/failures Flexibility Different providers per app One provider for all Portability Move apps easily Tied to infrastructure Overhead ~50MB per app Single deployment <p>Sidecar Benefits</p> <ul> <li>Simpler: No Istio ext_authz filter needed</li> <li>More reliable: No single point of failure</li> <li>Easier to debug: Auth logs are with your app</li> <li>More flexible: Each app can use different OAuth providers</li> </ul> <p>Centralized Benefits</p> <ul> <li>Lower resource usage: One oauth2-proxy for all apps</li> <li>Centralized management: Single place to update auth config</li> </ul> <p>For most use cases, the sidecar pattern's benefits outweigh the small resource overhead.</p>"},{"location":"architecture/overview/#why-not-service-mesh-mtls","title":"Why Not Service Mesh mTLS?","text":"<p>Service mesh mTLS provides service-to-service authentication but doesn't handle end-user authentication. You need both:</p> <ul> <li>mTLS: Encrypts and authenticates service communication</li> <li>OAuth2: Authenticates end users and provides identity</li> </ul> <p>They complement each other!</p>"},{"location":"architecture/overview/#cookie-based-sessions","title":"Cookie-Based Sessions","text":"<p>We use cookie-based sessions (not JWT or database-backed sessions) because:</p> <ul> <li>\u2705 Fast: No database lookup on every request</li> <li>\u2705 Scalable: Stateless, works with any replica</li> <li>\u2705 Simple: No session store to manage</li> <li>\u2705 Secure: Encrypted, httpOnly, secure flags</li> </ul> <p>The cookie is encrypted with the <code>cookie-secret</code>, so even if intercepted, it cannot be read or modified.</p>"},{"location":"architecture/overview/#security-considerations","title":"Security Considerations","text":"<p>See the Security Model page for detailed security information.</p>"},{"location":"architecture/overview/#next-steps","title":"Next Steps","text":"<ul> <li>Learn about the sidecar pattern</li> <li>Understand traffic flow</li> <li>Review security model</li> </ul>"},{"location":"architecture/security/","title":"Security Model","text":"<p>This document describes the security architecture and best practices for the OAuth2 sidecar proxy implementation.</p>"},{"location":"architecture/security/#security-architecture","title":"Security Architecture","text":"<pre><code>graph TB\n    subgraph \"External\"\n        User[User Browser]\n        OAuth[OAuth ProviderGitHub/Google/Azure]\n    end\n\n    subgraph \"Istio Service Mesh\"\n        Gateway[Istio GatewayTLS Termination]\n\n        subgraph \"Pod Security Context\"\n            subgraph \"Sidecar Container\"\n                Proxy[OAuth2 ProxyNon-root user: 2000Read-only filesystem]\n            end\n            subgraph \"App Container\"\n                App[ApplicationNon-root user: 1000Isolated]\n            end\n        end\n    end\n\n    subgraph \"Secrets Management\"\n        Secret[Kubernetes Secretoauth2-proxy-secret]\n        Azure[Azure Key VaultOptional]\n    end\n\n    User --&gt;|HTTPS TLS 1.2+| Gateway\n    Gateway --&gt;|mTLS| Proxy\n    Proxy --&gt;|localhost only| App\n    Proxy -.-&gt;|OAuth flow| OAuth\n    Secret --&gt;|Volume mount| Proxy\n    Azure -.-&gt;|SecretProviderClass| Secret\n\n    style Gateway fill:#f59e0b,color:#fff\n    style Proxy fill:#4f46e5,color:#fff\n    style App fill:#10b981,color:#fff\n    style Secret fill:#ef4444,color:#fff\n</code></pre>"},{"location":"architecture/security/#threat-model","title":"Threat Model","text":""},{"location":"architecture/security/#assets","title":"Assets","text":"<ol> <li>User Credentials: OAuth tokens and session cookies</li> <li>Application Secrets: Client ID, client secret, cookie secret</li> <li>User Data: Personal information in OAuth claims</li> <li>Application Data: Protected application resources</li> </ol>"},{"location":"architecture/security/#threats-mitigations","title":"Threats &amp; Mitigations","text":""},{"location":"architecture/security/#1-man-in-the-middle-mitm-attacks","title":"1. Man-in-the-Middle (MitM) Attacks","text":"<p>Threat: Attacker intercepts traffic between user and gateway</p> <p>Mitigations: - TLS 1.2+ enforced at Istio Gateway - HSTS headers enabled - Certificate pinning recommended for mobile apps - Mutual TLS (mTLS) within service mesh</p> <pre><code># Gateway TLS configuration\ntls:\n  mode: SIMPLE\n  minProtocolVersion: TLSV1_2\n  credentialName: wildcard-tls-secret\n</code></pre>"},{"location":"architecture/security/#2-session-hijacking","title":"2. Session Hijacking","text":"<p>Threat: Attacker steals session cookie</p> <p>Mitigations: - Secure, HttpOnly, SameSite=Lax cookies - Short cookie lifetime (7 days default) - Cookie refresh mechanism - AES-256 encryption of cookie data - HMAC signature verification</p> <pre><code>cookie_secure = true\ncookie_httponly = true\ncookie_samesite = \"lax\"\ncookie_expire = \"168h\"\ncookie_refresh = \"1h\"\n</code></pre>"},{"location":"architecture/security/#3-cross-site-request-forgery-csrf","title":"3. Cross-Site Request Forgery (CSRF)","text":"<p>Threat: Malicious site tricks user into making authenticated requests</p> <p>Mitigations: - SameSite=Lax cookie attribute - State parameter in OAuth flow - Origin validation for sensitive operations - CSRF tokens for state-changing operations</p>"},{"location":"architecture/security/#4-oauth-authorization-code-interception","title":"4. OAuth Authorization Code Interception","text":"<p>Threat: Attacker intercepts authorization code</p> <p>Mitigations: - HTTPS-only redirect URIs - State parameter validation - PKCE (Proof Key for Code Exchange) support - Short-lived authorization codes</p> <pre><code># OAuth configuration\nredirect_url = \"https://auth.example.com/oauth2/callback\"\n# State parameter automatically generated and validated\n</code></pre>"},{"location":"architecture/security/#5-container-escape","title":"5. Container Escape","text":"<p>Threat: Attacker escapes sidecar container</p> <p>Mitigations: - Non-root user (UID 2000) - Read-only root filesystem - Dropped capabilities - Pod security policies/standards - No privilege escalation</p> <pre><code>securityContext:\n  runAsNonRoot: true\n  runAsUser: 2000\n  allowPrivilegeEscalation: false\n  readOnlyRootFilesystem: true\n  capabilities:\n    drop:\n      - ALL\n</code></pre>"},{"location":"architecture/security/#6-secrets-exposure","title":"6. Secrets Exposure","text":"<p>Threat: Secrets leaked through logs, environment variables, or filesystem</p> <p>Mitigations: - Secrets stored in Kubernetes Secrets - Volume mounts (not environment variables) - Azure Key Vault integration available - No secrets in logs or error messages - Secret rotation support</p> <pre><code># Secret mounted as volume\nvolumeMounts:\n  - name: oauth2-proxy-secret\n    mountPath: /secrets\n    readOnly: true\n</code></pre>"},{"location":"architecture/security/#authentication-security","title":"Authentication Security","text":""},{"location":"architecture/security/#oauth-provider-selection","title":"OAuth Provider Selection","text":"<p>Choose providers with strong security practices:</p> Provider Security Features GitHub 2FA support, OAuth apps, fine-grained permissions Google Advanced Protection Program, OAuth 2.0 security best practices Azure AD Conditional Access, MFA, Enterprise security OIDC Flexible, standards-based, configurable security"},{"location":"architecture/security/#scopes-and-permissions","title":"Scopes and Permissions","text":"<p>Request minimal necessary scopes:</p> <pre><code># GitHub minimal scopes\nscope = \"user:email read:org\"\n\n# Google minimal scopes  \nscope = \"openid email profile\"\n\n# Azure AD minimal scopes\nscope = \"openid email profile\"\n</code></pre>"},{"location":"architecture/security/#token-management","title":"Token Management","text":"<p>Access Token Storage: - Stored encrypted in session cookie - Never logged or exposed to application - Automatic refresh if provider supports it</p> <p>Cookie Secret Rotation:</p> <pre><code># Generate new secret\nopenssl rand -base64 32\n\n# Update Kubernetes secret\nkubectl create secret generic oauth2-proxy-secret \\\n  --from-literal=cookie-secret=NEW_SECRET \\\n  --dry-run=client -o yaml | kubectl apply -f -\n\n# Restart pods\nkubectl rollout restart deployment/example-app\n</code></pre>"},{"location":"architecture/security/#network-security","title":"Network Security","text":""},{"location":"architecture/security/#istio-service-mesh","title":"Istio Service Mesh","text":"<pre><code>graph LR\n    subgraph \"External Traffic\"\n        Internet[Internet]\n    end\n\n    subgraph \"Istio Gateway Namespace\"\n        Gateway[Istio GatewayTLS Termination]\n    end\n\n    subgraph \"Application Namespace\"\n        VS[VirtualServiceRouting Rules]\n        AuthPolicy[AuthorizationPolicyAccess Control]\n\n        subgraph \"Pod\"\n            Envoy[Envoy Sidecar]\n            OAuth[OAuth2 Proxy]\n            App[Application]\n        end\n    end\n\n    Internet --&gt;|HTTPS| Gateway\n    Gateway --&gt;|mTLS| Envoy\n    VS --&gt; Envoy\n    AuthPolicy --&gt; Envoy\n    Envoy --&gt;|localhost| OAuth\n    OAuth --&gt;|localhost| App\n\n    style Gateway fill:#f59e0b,color:#fff\n    style OAuth fill:#4f46e5,color:#fff\n    style AuthPolicy fill:#ef4444,color:#fff\n</code></pre>"},{"location":"architecture/security/#network-policies","title":"Network Policies","text":"<p>Restrict traffic to/from OAuth2 proxy:</p> <pre><code>apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: oauth2-proxy-network-policy\nspec:\n  podSelector:\n    matchLabels:\n      app: example-app\n  policyTypes:\n    - Ingress\n    - Egress\n  ingress:\n    # Only from Istio ingress gateway\n    - from:\n      - namespaceSelector:\n          matchLabels:\n            name: istio-system\n      ports:\n        - protocol: TCP\n          port: 4180\n  egress:\n    # DNS\n    - to:\n      - namespaceSelector:\n          matchLabels:\n            name: kube-system\n      ports:\n        - protocol: UDP\n          port: 53\n    # OAuth provider (GitHub, Google, etc.)\n    - to:\n      - podSelector: {}\n      ports:\n        - protocol: TCP\n          port: 443\n</code></pre>"},{"location":"architecture/security/#localhost-communication","title":"Localhost Communication","text":"<p>Sidecar to application communication is restricted to localhost:</p> <pre><code># OAuth2 proxy upstream configuration\nOAUTH2_PROXY_UPSTREAMS=http://127.0.0.1:8080\n\n# Application listens only on localhost\nargs:\n  - -listen=:8080  # Binds to 127.0.0.1:8080\n</code></pre> <p>Benefits: - Cannot be accessed from outside the pod - No network policy needed for pod-internal traffic - Minimizes attack surface</p>"},{"location":"architecture/security/#authorization","title":"Authorization","text":""},{"location":"architecture/security/#istio-authorizationpolicy","title":"Istio AuthorizationPolicy","text":"<p>Enforce that all requests go through OAuth2 proxy:</p> <pre><code>apiVersion: security.istio.io/v1\nkind: AuthorizationPolicy\nmetadata:\n  name: require-oauth2-auth\n  namespace: default\nspec:\n  action: DENY\n  rules:\n    # Deny direct access to application port\n    - to:\n      - operation:\n          ports: [\"8080\"]\n    # Allow only from localhost (sidecar)\n    - from:\n      - source:\n          notPrincipals: [\"cluster.local/ns/default/sa/example-app\"]\n</code></pre>"},{"location":"architecture/security/#email-domain-restrictions","title":"Email Domain Restrictions","text":"<p>Restrict access by email domain:</p> <pre><code># Allow only company domain\nemail_domains = [\"example.com\"]\n\n# Allow multiple domains\nemail_domains = [\"example.com\", \"partner.com\"]\n\n# Allow all domains (not recommended for production)\nemail_domains = [\"*\"]\n</code></pre>"},{"location":"architecture/security/#github-organizationteam-restrictions","title":"GitHub Organization/Team Restrictions","text":"<pre><code># GitHub organization\n--github-org=\"mycompany\"\n\n# GitHub team (requires org)\n--github-org=\"mycompany\"\n--github-team=\"engineering\"\n</code></pre>"},{"location":"architecture/security/#custom-authorization","title":"Custom Authorization","text":"<p>Implement custom authorization in your application using headers:</p> <pre><code># Python Flask example\nfrom functools import wraps\nfrom flask import request, abort\n\ndef require_admin(f):\n    @wraps(f)\n    def decorated(*args, **kwargs):\n        email = request.headers.get('X-Auth-Request-Email')\n        if not email or not email.endswith('@example.com'):\n            abort(403)\n        # Check if user is admin in your database\n        if not is_admin(email):\n            abort(403)\n        return f(*args, **kwargs)\n    return decorated\n\n@app.route('/admin')\n@require_admin\ndef admin_panel():\n    return \"Admin Panel\"\n</code></pre>"},{"location":"architecture/security/#logging-and-monitoring","title":"Logging and Monitoring","text":""},{"location":"architecture/security/#security-audit-logging","title":"Security Audit Logging","text":"<p>Enable comprehensive logging:</p> <pre><code># OAuth2 proxy configuration\nstandard-logging = true\nauth-logging = true\nrequest-logging = true\nlogging-level = \"info\"\n</code></pre>"},{"location":"architecture/security/#sensitive-data-redaction","title":"Sensitive Data Redaction","text":"<p>OAuth2-proxy automatically redacts: - Cookie values - Authorization headers - Access tokens - Client secrets</p>"},{"location":"architecture/security/#monitoring-metrics","title":"Monitoring Metrics","text":"<p>Key security metrics to monitor:</p> <pre><code># Prometheus metrics\noauth2_proxy_requests_total{method=\"GET\",path=\"/oauth2/sign_in\"}\noauth2_proxy_authentication_failures_total\noauth2_proxy_authentication_attempts_total\noauth2_proxy_cookies_expired_total\n</code></pre>"},{"location":"architecture/security/#security-alerts","title":"Security Alerts","text":"<p>Set up alerts for:</p> <ol> <li> <p>High authentication failure rate <pre><code>rate(oauth2_proxy_authentication_failures_total[5m]) &gt; 10\n</code></pre></p> </li> <li> <p>Unusual access patterns <pre><code>sum(rate(oauth2_proxy_requests_total[5m])) by (path) &gt; 1000\n</code></pre></p> </li> <li> <p>Token refresh failures <pre><code>rate(oauth2_proxy_token_refresh_errors_total[5m]) &gt; 1\n</code></pre></p> </li> </ol>"},{"location":"architecture/security/#compliance","title":"Compliance","text":""},{"location":"architecture/security/#gdpr-considerations","title":"GDPR Considerations","text":"<p>Data Minimization: - Request only necessary OAuth scopes - Don't store unnecessary user data - Implement data retention policies</p> <p>Right to Erasure: - Provide sign-out functionality - Clear all session data on sign-out - Implement account deletion workflows</p> <p>Data Portability: - Expose user data through API - Allow users to download their data</p>"},{"location":"architecture/security/#soc-2-iso-27001","title":"SOC 2 / ISO 27001","text":"<p>Access Control: - Strong authentication required - Role-based access control (RBAC) - Audit logging enabled</p> <p>Encryption: - TLS 1.2+ for data in transit - AES-256 for session cookies - Secrets encrypted at rest in Kubernetes</p> <p>Incident Response: - Centralized logging - Security event monitoring - Automated alerting</p>"},{"location":"architecture/security/#security-best-practices","title":"Security Best Practices","text":""},{"location":"architecture/security/#development","title":"Development","text":"<ol> <li> <p>Keep Dependencies Updated <pre><code># Update oauth2-proxy image\nimage: quay.io/oauth2-proxy/oauth2-proxy:v7.6.0\n</code></pre></p> </li> <li> <p>Use Specific Image Tags</p> </li> <li>Don't use <code>latest</code> tag</li> <li>Pin to specific versions</li> <li> <p>Test updates in staging first</p> </li> <li> <p>Scan Images for Vulnerabilities <pre><code>trivy image quay.io/oauth2-proxy/oauth2-proxy:v7.6.0\n</code></pre></p> </li> </ol>"},{"location":"architecture/security/#deployment","title":"Deployment","text":"<ol> <li> <p>Use Azure Key Vault for Secrets <pre><code>apiVersion: secrets-store.csi.x-k8s.io/v1\nkind: SecretProviderClass\nmetadata:\n  name: oauth2-proxy-azure-kv\nspec:\n  provider: azure\n  parameters:\n    keyvaultName: \"my-key-vault\"\n    objects: |\n      array:\n        - objectName: \"oauth2-client-id\"\n          objectType: \"secret\"\n        - objectName: \"oauth2-client-secret\"\n          objectType: \"secret\"\n</code></pre></p> </li> <li> <p>Enable Pod Security Standards <pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  name: default\n  labels:\n    pod-security.kubernetes.io/enforce: restricted\n    pod-security.kubernetes.io/audit: restricted\n    pod-security.kubernetes.io/warn: restricted\n</code></pre></p> </li> <li> <p>Implement Network Segmentation</p> </li> <li>Separate namespaces for different apps</li> <li>Network policies between namespaces</li> <li>Egress filtering for external services</li> </ol>"},{"location":"architecture/security/#operations","title":"Operations","text":"<ol> <li>Regular Security Audits</li> <li>Review access logs weekly</li> <li>Audit OAuth application configurations</li> <li> <p>Check for unused service accounts</p> </li> <li> <p>Incident Response Plan</p> </li> <li>Document escalation procedures</li> <li>Practice incident response drills</li> <li> <p>Maintain runbooks for common issues</p> </li> <li> <p>Secret Rotation Schedule</p> </li> <li>Rotate cookie secrets quarterly</li> <li>Rotate OAuth credentials annually</li> <li>Rotate TLS certificates before expiry</li> </ol>"},{"location":"architecture/security/#security-checklist","title":"Security Checklist","text":""},{"location":"architecture/security/#pre-production","title":"Pre-Production","text":"<ul> <li> TLS 1.2+ enforced on Istio Gateway</li> <li> Certificate from trusted CA installed</li> <li> OAuth provider application configured with correct callback URL</li> <li> Email domain restrictions configured (if applicable)</li> <li> Cookie secrets generated with sufficient entropy</li> <li> Secrets stored in Kubernetes Secrets or Key Vault</li> <li> Pod Security Standards enabled</li> <li> Network policies defined</li> <li> Resource limits set on containers</li> <li> Non-root users configured</li> <li> Read-only root filesystem enabled</li> <li> All capabilities dropped</li> </ul>"},{"location":"architecture/security/#production","title":"Production","text":"<ul> <li> Monitoring and alerting configured</li> <li> Log aggregation and retention configured</li> <li> Incident response plan documented</li> <li> Security audit logging enabled</li> <li> Regular vulnerability scanning scheduled</li> <li> Secret rotation schedule defined</li> <li> Backup and disaster recovery plan</li> <li> Compliance requirements met</li> </ul>"},{"location":"architecture/security/#ongoing","title":"Ongoing","text":"<ul> <li> Review access logs monthly</li> <li> Update dependencies quarterly</li> <li> Rotate secrets per schedule</li> <li> Audit OAuth configurations quarterly</li> <li> Review and update security policies annually</li> </ul>"},{"location":"architecture/security/#resources","title":"Resources","text":"<ul> <li>OAuth 2.0 Security Best Practices</li> <li>OAuth2-Proxy Documentation</li> <li>Istio Security Best Practices</li> <li>Kubernetes Security Best Practices</li> <li>OWASP Top 10</li> </ul>"},{"location":"architecture/security/#next-steps","title":"Next Steps","text":"<ul> <li>Configure OAuth Providers</li> <li>Production Deployment Guide</li> <li>Troubleshooting Security Issues</li> </ul>"},{"location":"architecture/sidecar-pattern/","title":"Sidecar Pattern Deep Dive","text":"<p>Understanding the sidecar pattern and how it applies to OAuth2 authentication.</p>"},{"location":"architecture/sidecar-pattern/#what-is-the-sidecar-pattern","title":"What is the Sidecar Pattern?","text":"<p>The sidecar pattern is a microservices design pattern where auxiliary functionality is deployed alongside the main application container in the same pod. The sidecar container extends and enhances the main container's behavior.</p> <pre><code>graph TB\n    subgraph \"Traditional Deployment\"\n        A[Applicationwith embedded auth]\n    end\n\n    subgraph \"Sidecar Pattern\"\n        B[Applicationpure business logic]\n        C[Sidecarauth logic]\n        B &lt;--&gt; C\n    end\n\n    style B fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n    style C fill:#4c51bf,stroke:#333,stroke-width:2px,color:#fff\n</code></pre>"},{"location":"architecture/sidecar-pattern/#benefits-for-authentication","title":"Benefits for Authentication","text":""},{"location":"architecture/sidecar-pattern/#1-separation-of-concerns","title":"1. Separation of Concerns","text":"<p>Your application focuses on business logic, while the sidecar handles authentication.</p> <p>Without sidecar: <pre><code># Your app code mixed with auth logic\nfrom flask import Flask, session, redirect\nimport oauth_lib\n\napp = Flask(__name__)\n\n@app.route('/')\ndef index():\n    if not session.get('user'):\n        return redirect('/login')\n    # Business logic here\n    return f\"Hello {session['user']}\"\n\n@app.route('/login')\ndef login():\n    # OAuth dance...\n    return oauth_lib.authorize()\n</code></pre></p> <p>With sidecar: <pre><code># Your app code - pure business logic\nfrom flask import Flask, request\n\napp = Flask(__name__)\n\n@app.route('/')\ndef index():\n    # User is already authenticated by sidecar\n    user = request.headers.get('X-Auth-Request-User')\n    return f\"Hello {user}\"\n</code></pre></p>"},{"location":"architecture/sidecar-pattern/#2-language-agnostic","title":"2. Language Agnostic","text":"<p>The sidecar works with any programming language or framework.</p> <pre><code>graph TB\n    subgraph Applications\n        A[Python/Flask]\n        B[Node.js/Express]\n        C[Go/net/http]\n        D[Java/Spring]\n        E[.NET/ASP.NET]\n    end\n\n    subgraph \"oauth2-proxy Sidecar\"\n        F[Handles OAuth for ALL]\n    end\n\n    A -.-&gt;|Works with| F\n    B -.-&gt;|Works with| F\n    C -.-&gt;|Works with| F\n    D -.-&gt;|Works with| F\n    E -.-&gt;|Works with| F\n\n    style F fill:#4c51bf,stroke:#333,stroke-width:3px,color:#fff\n</code></pre>"},{"location":"architecture/sidecar-pattern/#3-easy-updates","title":"3. Easy Updates","text":"<p>Update authentication logic without changing application code.</p> <pre><code>graph LR\n    A[Update oauth2-proxyimage version] --&gt; B[Restart pod]\n    B --&gt; C[New auth featureswithout app changes]\n\n    style C fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n</code></pre>"},{"location":"architecture/sidecar-pattern/#4-consistent-security","title":"4. Consistent Security","text":"<p>All applications get the same security controls automatically.</p>"},{"location":"architecture/sidecar-pattern/#pod-architecture","title":"Pod Architecture","text":""},{"location":"architecture/sidecar-pattern/#network-sharing","title":"Network Sharing","text":"<p>Containers in the same pod share the same network namespace, enabling communication via <code>localhost</code>.</p> <pre><code>graph TB\n    subgraph Pod Network Namespace\n        direction LR\n        subgraph \"oauth2-proxy\"\n            A[\":4180\"]\n        end\n        subgraph \"application\"\n            B[\":8080\"]\n        end\n        A --&gt;|localhost:8080| B\n    end\n\n    C[External Traffic:4180] --&gt; A\n\n    style A fill:#4c51bf,stroke:#333,stroke-width:2px,color:#fff\n    style B fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n</code></pre> <p>Key Points: - oauth2-proxy listens on <code>:4180</code> (exposed externally via Service) - Application listens on <code>:8080</code> (only accessible within pod) - Communication is fast (localhost, no network overhead) - Application port is never exposed externally</p>"},{"location":"architecture/sidecar-pattern/#volume-sharing","title":"Volume Sharing","text":"<p>Containers can share volumes for configuration and templates.</p> <pre><code>spec:\n  containers:\n  - name: oauth2-proxy\n    volumeMounts:\n    - name: config\n      mountPath: /etc/oauth2-proxy\n    - name: templates\n      mountPath: /templates\n\n  - name: app\n    volumeMounts:\n    - name: app-config\n      mountPath: /etc/app\n\n  volumes:\n  - name: config\n    configMap:\n      name: oauth2-proxy-config\n  - name: templates\n    configMap:\n      name: oauth2-proxy-templates\n  - name: app-config\n    configMap:\n      name: app-config\n</code></pre>"},{"location":"architecture/sidecar-pattern/#lifecycle-management","title":"Lifecycle Management","text":"<p>Both containers start and stop together.</p> <pre><code>stateDiagram-v2\n    [*] --&gt; Pending: kubectl apply\n    Pending --&gt; Running: Both containers start\n    Running --&gt; Terminating: kubectl delete\n    Terminating --&gt; [*]: Both containers stop\n\n    note right of Running\n        If either container fails,\n        pod is restarted\n    end note\n</code></pre>"},{"location":"architecture/sidecar-pattern/#request-flow","title":"Request Flow","text":""},{"location":"architecture/sidecar-pattern/#detailed-request-flow","title":"Detailed Request Flow","text":"<pre><code>sequenceDiagram\n    autonumber\n    participant Client\n    participant Service\n    participant Proxy as oauth2-proxy:4180\n    participant App as application:8080\n\n    Client-&gt;&gt;Service: GET / HTTP/1.1Host: app.example.com\n    Service-&gt;&gt;Proxy: Forward to podport 4180\n\n    alt Cookie Present\n        Proxy-&gt;&gt;Proxy: Validate cookie\n        Proxy-&gt;&gt;App: GET / HTTP/1.1X-Auth-Request-Email: user@example.comX-Auth-Request-User: user\n        App-&gt;&gt;Proxy: HTTP/1.1 200 OKContent\n        Proxy-&gt;&gt;Client: HTTP/1.1 200 OKContent\n    else No Cookie\n        Proxy-&gt;&gt;Client: HTTP/1.1 200 OKSign-in page HTML\n        Client-&gt;&gt;Proxy: Click OAuth button\n        Proxy-&gt;&gt;Client: HTTP/1.1 302 FoundLocation: https://github.com/login...\n    end\n</code></pre>"},{"location":"architecture/sidecar-pattern/#header-injection","title":"Header Injection","text":"<p>The oauth2-proxy sidecar automatically injects user information:</p> Header Description Example <code>X-Auth-Request-User</code> User identifier <code>octocat</code> <code>X-Auth-Request-Email</code> User email <code>octocat@github.com</code> <code>X-Auth-Request-Preferred-Username</code> Preferred username <code>octocat</code> <code>X-Forwarded-User</code> Forwarded user <code>octocat</code> <code>X-Forwarded-Email</code> Forwarded email <code>octocat@github.com</code> <code>Authorization</code> Bearer token (optional) <code>Bearer eyJ...</code>"},{"location":"architecture/sidecar-pattern/#configuration","title":"Configuration","text":""},{"location":"architecture/sidecar-pattern/#pod-level-configuration","title":"Pod-Level Configuration","text":"<p>Each pod can have its own authentication configuration.</p> <pre><code>apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: app1\nspec:\n  template:\n    spec:\n      containers:\n      - name: oauth2-proxy\n        env:\n        # App-specific redirect URL\n        - name: OAUTH2_PROXY_REDIRECT_URL\n          value: \"https://app1.example.com/oauth2/callback\"\n        # App-specific upstream\n        - name: OAUTH2_PROXY_UPSTREAMS\n          value: \"http://127.0.0.1:8080\"\n</code></pre>"},{"location":"architecture/sidecar-pattern/#shared-configuration","title":"Shared Configuration","text":"<p>Common settings are shared via ConfigMap.</p> <pre><code>graph TB\n    A[ConfigMapoauth2-proxy-config] --&gt; B[app1 pod]\n    A --&gt; C[app2 pod]\n    A --&gt; D[app3 pod]\n\n    E[Secretoauth2-proxy-secret] --&gt; B\n    E --&gt; C\n    E --&gt; D\n\n    style A fill:#f59e0b,stroke:#333,stroke-width:2px,color:#fff\n    style E fill:#ef4444,stroke:#333,stroke-width:2px,color:#fff\n</code></pre> <p>Shared via ConfigMap: - OAuth provider type - Cookie settings - Email domain restrictions - Template configuration</p> <p>Shared via Secret: - OAuth client ID &amp; secret - Cookie encryption secret</p> <p>Per-pod via Environment: - Redirect URL (app-specific) - Upstream port (app-specific)</p>"},{"location":"architecture/sidecar-pattern/#resource-management","title":"Resource Management","text":""},{"location":"architecture/sidecar-pattern/#resource-requests-and-limits","title":"Resource Requests and Limits","text":"<p>Each sidecar has its own resource allocation.</p> <pre><code>containers:\n- name: oauth2-proxy\n  resources:\n    requests:\n      memory: \"64Mi\"\n      cpu: \"50m\"\n    limits:\n      memory: \"128Mi\"\n      cpu: \"200m\"\n\n- name: app\n  resources:\n    requests:\n      memory: \"256Mi\"\n      cpu: \"100m\"\n    limits:\n      memory: \"512Mi\"\n      cpu: \"500m\"\n</code></pre> <p>Typical Resource Usage:</p> Container Memory CPU Notes oauth2-proxy 50-100 MB 10-50m Low overhead Application Varies Varies Your app's needs"},{"location":"architecture/sidecar-pattern/#scaling-considerations","title":"Scaling Considerations","text":"<pre><code>graph TB\n    subgraph \"3 Replicas\"\n        A[app-pod-1oauth2-proxy + app]\n        B[app-pod-2oauth2-proxy + app]\n        C[app-pod-3oauth2-proxy + app]\n    end\n\n    D[Service] --&gt; A\n    D --&gt; B\n    D --&gt; C\n\n    E[Each pod:~150MB total] -.-&gt; A\n    E -.-&gt; B\n    E -.-&gt; C\n</code></pre> <p>Scaling Impact: - Each replica adds one oauth2-proxy sidecar - At 10 replicas \u00d7 100MB = 1GB overhead - Trade-off: More memory for better isolation</p>"},{"location":"architecture/sidecar-pattern/#comparison-with-alternatives","title":"Comparison with Alternatives","text":""},{"location":"architecture/sidecar-pattern/#vs-centralized-oauth2-proxy","title":"vs. Centralized oauth2-proxy","text":"<pre><code>graph TB\n    subgraph \"Centralized\"\n        direction TB\n        A[oauth2-proxydeployment] --&gt; B[app1]\n        A --&gt; C[app2]\n        A --&gt; D[app3]\n        E[Complex Istioext_authz config] -.-&gt; A\n    end\n\n    subgraph \"Sidecar\"\n        direction TB\n        F[app1 + sidecar]\n        G[app2 + sidecar]\n        H[app3 + sidecar]\n        I[Simple podconfiguration] -.-&gt; F\n    end\n\n    style A fill:#ef4444,stroke:#333,stroke-width:2px,color:#fff\n    style E fill:#ef4444,stroke:#333,stroke-width:2px,color:#fff\n    style I fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n</code></pre> Feature Sidecar Centralized Configuration \u2705 Simple \u274c Complex Debugging \u2705 Easy \u274c Distributed Isolation \u2705 Per-app \u274c Shared Flexibility \u2705 Per-app providers \u274c Single provider Resources \u26a0\ufe0f Higher \u2705 Lower Portability \u2705 Easy \u274c Infrastructure-tied"},{"location":"architecture/sidecar-pattern/#vs-application-embedded-auth","title":"vs. Application-Embedded Auth","text":"<pre><code>graph LR\n    subgraph \"Embedded Auth\"\n        A[App Code] --&gt; B[Auth Library]\n        B --&gt; C[OAuth Provider]\n    end\n\n    subgraph \"Sidecar\"\n        D[App Code] --&gt; E[oauth2-proxy]\n        E --&gt; F[OAuth Provider]\n    end\n\n    style A fill:#f59e0b,stroke:#333,stroke-width:2px,color:#fff\n    style B fill:#f59e0b,stroke:#333,stroke-width:2px,color:#fff\n    style D fill:#10b981,stroke:#333,stroke-width:2px,color:#fff\n    style E fill:#4c51bf,stroke:#333,stroke-width:2px,color:#fff\n</code></pre> Aspect Sidecar Embedded Code changes \u2705 None needed \u274c Must implement Language support \u2705 Any language \u26a0\ufe0f Library dependent Security updates \u2705 Update image \u274c Code change + deploy Consistency \u2705 Same for all apps \u274c Varies by app Testing \u2705 Test separately \u274c Test with app"},{"location":"architecture/sidecar-pattern/#best-practices","title":"Best Practices","text":""},{"location":"architecture/sidecar-pattern/#1-use-shared-configmaps","title":"1. Use Shared ConfigMaps","text":"<p>Create one ConfigMap for common settings, environment variables for app-specific settings.</p>"},{"location":"architecture/sidecar-pattern/#2-monitor-both-containers","title":"2. Monitor Both Containers","text":"<pre><code># Check both containers\nkubectl logs pod-name -c oauth2-proxy\nkubectl logs pod-name -c app\n</code></pre>"},{"location":"architecture/sidecar-pattern/#3-health-checks","title":"3. Health Checks","text":"<p>Configure health checks for both containers:</p> <pre><code>containers:\n- name: oauth2-proxy\n  livenessProbe:\n    httpGet:\n      path: /ping\n      port: 4180\n  readinessProbe:\n    httpGet:\n      path: /ping\n      port: 4180\n\n- name: app\n  livenessProbe:\n    httpGet:\n      path: /health\n      port: 8080\n</code></pre>"},{"location":"architecture/sidecar-pattern/#4-resource-limits","title":"4. Resource Limits","text":"<p>Always set resource limits to prevent resource contention.</p>"},{"location":"architecture/sidecar-pattern/#5-logging","title":"5. Logging","text":"<p>Structure logs for easy correlation:</p> <pre><code>{\n  \"container\": \"oauth2-proxy\",\n  \"pod\": \"app-7d8f6b-abc123\",\n  \"level\": \"info\",\n  \"msg\": \"Authentication successful\"\n}\n</code></pre>"},{"location":"architecture/sidecar-pattern/#next-steps","title":"Next Steps","text":"<ul> <li>Understand traffic flow in detail</li> <li>Learn about security considerations</li> <li>Add sidecar to your app</li> </ul>"},{"location":"architecture/traffic-flow/","title":"OAuth Authentication Flow","text":"<p>This document describes the complete OAuth2 authentication flow when using the sidecar pattern.</p>"},{"location":"architecture/traffic-flow/#overview","title":"Overview","text":"<p>The OAuth2 sidecar proxy handles authentication transparently, redirecting unauthenticated users through an OAuth flow and maintaining session cookies for authenticated users.</p>"},{"location":"architecture/traffic-flow/#authentication-flow-diagram","title":"Authentication Flow Diagram","text":"<pre><code>sequenceDiagram\n    participant User as User Browser\n    participant Istio as Istio Gateway\n    participant Sidecar as OAuth2 Proxy(Sidecar)\n    participant App as Application\n    participant OAuth as OAuth Provider(GitHub/Google/Azure)\n\n    User-&gt;&gt;Istio: 1. Request https://app.example.com/\n    Istio-&gt;&gt;Sidecar: 2. Forward to Pod(port 4180)\n\n    Note over Sidecar: Check for validsession cookie\n\n    alt No Valid Session\n        Sidecar-&gt;&gt;User: 3. Show sign-in page(custom template)\n        User-&gt;&gt;Sidecar: 4. Click provider button(e.g., GitHub)\n        Sidecar-&gt;&gt;User: 5. Redirect to /oauth2/start\n        Sidecar-&gt;&gt;User: 6. Redirect to OAuth providerwith callback URL\n        User-&gt;&gt;OAuth: 7. Login &amp; authorize\n        OAuth-&gt;&gt;User: 8. Redirect to callbackwith auth code\n        User-&gt;&gt;Istio: 9. Request callback URLhttps://auth.example.com/oauth2/callback\n        Istio-&gt;&gt;Sidecar: 10. Forward callback\n        Sidecar-&gt;&gt;OAuth: 11. Exchange code for token\n        OAuth-&gt;&gt;Sidecar: 12. Return access token\n        Note over Sidecar: Create session,set cookie\n        Sidecar-&gt;&gt;User: 13. Redirect to original URLwith session cookie\n        User-&gt;&gt;Istio: 14. Request original URLwith cookie\n        Istio-&gt;&gt;Sidecar: 15. Forward request\n    end\n\n    Note over Sidecar: Valid session found\n    Sidecar-&gt;&gt;App: 16. Proxy to appon localhost:8080+ inject headers\n    App-&gt;&gt;Sidecar: 17. Response\n    Sidecar-&gt;&gt;User: 18. Return response\n</code></pre>"},{"location":"architecture/traffic-flow/#step-by-step-flow","title":"Step-by-Step Flow","text":""},{"location":"architecture/traffic-flow/#1-initial-request-unauthenticated","title":"1. Initial Request (Unauthenticated)","text":"<p>When a user first visits <code>https://app.example.com/</code>, they don't have a valid session cookie:</p> <pre><code>GET / HTTP/1.1\nHost: app.example.com\n</code></pre>"},{"location":"architecture/traffic-flow/#2-sign-in-page-display","title":"2. Sign-in Page Display","text":"<p>The OAuth2 proxy sidecar checks for a session cookie. If none is found or it's expired, the proxy serves a custom sign-in page instead of auto-redirecting:</p> <pre><code># ConfigMap configuration\nskip_provider_button = false\ncustom_templates_dir = \"/templates\"\n</code></pre> <p>The sign-in page displays provider options (GitHub, Google, etc.) with branded buttons.</p>"},{"location":"architecture/traffic-flow/#3-oauth-provider-selection","title":"3. OAuth Provider Selection","text":"<p>When the user clicks a provider button (e.g., \"Sign in with GitHub\"), the browser navigates to:</p> <pre><code>https://app.example.com/oauth2/start\n</code></pre>"},{"location":"architecture/traffic-flow/#4-redirect-to-oauth-provider","title":"4. Redirect to OAuth Provider","text":"<p>The sidecar generates an OAuth authorization URL and redirects:</p> <pre><code>HTTP/1.1 302 Found\nLocation: https://github.com/login/oauth/authorize?\n  client_id=YOUR_CLIENT_ID\n  &amp;redirect_uri=https://auth.example.com/oauth2/callback\n  &amp;response_type=code\n  &amp;scope=user:email read:org\n  &amp;state=ENCRYPTED_STATE_WITH_RETURN_URL\n</code></pre> <p>Key parameters:</p> <ul> <li><code>redirect_uri</code>: Centralized callback domain (e.g., <code>auth.example.com</code>)</li> <li><code>state</code>: Encrypted state containing the original return URL</li> <li><code>scope</code>: Requested OAuth scopes</li> </ul>"},{"location":"architecture/traffic-flow/#5-user-authorization","title":"5. User Authorization","text":"<p>The user authenticates with the OAuth provider (GitHub, Google, Azure AD, etc.) and grants permissions.</p>"},{"location":"architecture/traffic-flow/#6-callback-with-authorization-code","title":"6. Callback with Authorization Code","text":"<p>The OAuth provider redirects back to the callback URL with an authorization code:</p> <pre><code>https://auth.example.com/oauth2/callback?\n  code=AUTHORIZATION_CODE\n  &amp;state=ENCRYPTED_STATE_WITH_RETURN_URL\n</code></pre>"},{"location":"architecture/traffic-flow/#7-token-exchange","title":"7. Token Exchange","text":"<p>The sidecar exchanges the authorization code for an access token:</p> <pre><code>POST https://github.com/login/oauth/access_token\nContent-Type: application/x-www-form-urlencoded\n\nclient_id=YOUR_CLIENT_ID\n&amp;client_secret=YOUR_CLIENT_SECRET\n&amp;code=AUTHORIZATION_CODE\n&amp;redirect_uri=https://auth.example.com/oauth2/callback\n</code></pre> <p>Response:</p> <pre><code>{\n  \"access_token\": \"gho_xxxxxxxxxxxxx\",\n  \"token_type\": \"bearer\",\n  \"scope\": \"user:email,read:org\"\n}\n</code></pre>"},{"location":"architecture/traffic-flow/#8-session-creation","title":"8. Session Creation","text":"<p>The sidecar creates a session and sets a secure cookie:</p> <pre><code>HTTP/1.1 302 Found\nLocation: https://app.example.com/\nSet-Cookie: _oauth2_proxy=ENCRYPTED_SESSION_DATA; \n  Domain=.example.com; \n  Path=/; \n  Secure; \n  HttpOnly; \n  SameSite=Lax; \n  Max-Age=604800\n</code></pre> <p>Cookie characteristics:</p> <ul> <li>Domain: <code>.example.com</code> (enables SSO across subdomains)</li> <li>Secure: Only sent over HTTPS</li> <li>HttpOnly: Not accessible to JavaScript</li> <li>SameSite=Lax: Protects against CSRF</li> <li>Max-Age: 7 days (configurable)</li> </ul>"},{"location":"architecture/traffic-flow/#9-authenticated-request","title":"9. Authenticated Request","text":"<p>Subsequent requests include the session cookie:</p> <pre><code>GET /dashboard HTTP/1.1\nHost: app.example.com\nCookie: _oauth2_proxy=ENCRYPTED_SESSION_DATA\n</code></pre>"},{"location":"architecture/traffic-flow/#10-request-proxying-with-headers","title":"10. Request Proxying with Headers","text":"<p>The sidecar validates the session and proxies the request to the application container, injecting user information as headers:</p> <pre><code>GET /dashboard HTTP/1.1\nHost: localhost:8080\nX-Auth-Request-User: john.doe\nX-Auth-Request-Email: john.doe@example.com\nX-Auth-Request-Preferred-Username: johndoe\nX-Auth-Request-Access-Token: gho_xxxxxxxxxxxxx\nAuthorization: Bearer gho_xxxxxxxxxxxxx\n</code></pre>"},{"location":"architecture/traffic-flow/#centralized-vs-per-app-callbacks","title":"Centralized vs. Per-App Callbacks","text":""},{"location":"architecture/traffic-flow/#centralized-callback-domain","title":"Centralized Callback Domain","text":"<p>The sidecar architecture uses a centralized callback domain for all applications:</p> <pre><code>https://auth.example.com/oauth2/callback\n</code></pre> <p>Benefits:</p> <ul> <li>Single OAuth app configuration per provider</li> <li>Shared SSO cookie across all apps</li> <li>Simplified DNS and certificate management</li> <li>Consistent user experience</li> </ul>"},{"location":"architecture/traffic-flow/#configuration","title":"Configuration","text":"<pre><code># Deployment environment variable\n- name: OAUTH2_PROXY_REDIRECT_URL\n  value: \"https://auth.example.com/oauth2/callback\"\n\n# ConfigMap\ncookie_domains = [\".example.com\"]\nwhitelist_domains = [\".example.com\"]\n</code></pre>"},{"location":"architecture/traffic-flow/#session-management","title":"Session Management","text":""},{"location":"architecture/traffic-flow/#cookie-structure","title":"Cookie Structure","text":"<p>The session cookie contains encrypted data:</p> <pre><code>_oauth2_proxy=v4|encrypted_data|signature\n</code></pre> <p>Components:</p> <ul> <li>Version: Cookie format version</li> <li>Encrypted Data: User email, access token, expiry</li> <li>Signature: HMAC signature for integrity</li> </ul>"},{"location":"architecture/traffic-flow/#cookie-refresh","title":"Cookie Refresh","text":"<p>Cookies are automatically refreshed:</p> <pre><code>cookie_expire = \"168h\"  # 7 days total lifetime\ncookie_refresh = \"1h\"   # Refresh if older than 1 hour\n</code></pre> <p>When a cookie is older than 1 hour but younger than 7 days, the sidecar refreshes it by validating the access token and issuing a new cookie.</p>"},{"location":"architecture/traffic-flow/#sign-out-flow","title":"Sign Out Flow","text":"<pre><code>sequenceDiagram\n    participant User\n    participant Sidecar as OAuth2 Proxy\n    participant App\n\n    User-&gt;&gt;App: Click \"Sign Out\"\n    App-&gt;&gt;Sidecar: Redirect to /oauth2/sign_out?rd=/\n    Note over Sidecar: Clear session cookie\n    Sidecar-&gt;&gt;User: Redirect with cleared cookie\n    User-&gt;&gt;Sidecar: Next request (no cookie)\n    Sidecar-&gt;&gt;User: Show sign-in page\n</code></pre> <p>Sign-out URL format:</p> <pre><code>/oauth2/sign_out?rd=https://app.example.com/\n</code></pre> <p>The <code>rd</code> parameter specifies where to redirect after sign-out.</p>"},{"location":"architecture/traffic-flow/#security-considerations","title":"Security Considerations","text":""},{"location":"architecture/traffic-flow/#state-parameter","title":"State Parameter","text":"<p>The <code>state</code> parameter prevents CSRF attacks:</p> <pre><code>state = encrypt(original_url + timestamp + random_nonce)\n</code></pre> <p>The sidecar validates the state parameter on callback to ensure the request originated from the same session.</p>"},{"location":"architecture/traffic-flow/#cookie-security","title":"Cookie Security","text":"<p>Cookies are encrypted using AES-256 with a secret key:</p> <pre><code># Kubernetes Secret\nOAUTH2_PROXY_COOKIE_SECRET: &lt;base64-encoded-32-byte-key&gt;\n</code></pre>"},{"location":"architecture/traffic-flow/#token-storage","title":"Token Storage","text":"<p>Access tokens are stored encrypted in the session cookie, not in server-side storage. This enables stateless operation across multiple sidecar instances.</p>"},{"location":"architecture/traffic-flow/#error-handling","title":"Error Handling","text":""},{"location":"architecture/traffic-flow/#common-error-scenarios","title":"Common Error Scenarios","text":"<ol> <li>Invalid/Expired Session</li> <li> <p>Clear cookie and redirect to sign-in page</p> </li> <li> <p>OAuth Provider Error</p> </li> <li>Display custom error page with details</li> <li> <p>Allow user to retry</p> </li> <li> <p>Invalid State Parameter</p> </li> <li>Clear session and redirect to sign-in</li> <li> <p>Log security event</p> </li> <li> <p>Token Refresh Failure</p> </li> <li>Clear session and require re-authentication</li> </ol>"},{"location":"architecture/traffic-flow/#custom-error-pages","title":"Custom Error Pages","text":"<p>Configure custom error templates:</p> <pre><code>custom_templates_dir = \"/templates\"\n# error.html template available\n</code></pre>"},{"location":"architecture/traffic-flow/#network-flow-architecture","title":"Network Flow Architecture","text":"<pre><code>graph TB\n    subgraph \"Kubernetes Pod\"\n        Sidecar[OAuth2 Proxy:4180]\n        App[Application:8080]\n        Sidecar --&gt;|localhost| App\n    end\n\n    subgraph \"Istio\"\n        Gateway[Gateway]\n        VirtualService[VirtualService]\n    end\n\n    User[User Browser] --&gt;|HTTPS| Gateway\n    Gateway --&gt; VirtualService\n    VirtualService --&gt;|:4180| Sidecar\n\n    Sidecar -.-&gt;|OAuth flow| OAuth[OAuth Provider]\n\n    style Sidecar fill:#4f46e5,color:#fff\n    style App fill:#10b981,color:#fff\n</code></pre>"},{"location":"architecture/traffic-flow/#configuration-reference","title":"Configuration Reference","text":""},{"location":"architecture/traffic-flow/#deployment-configuration","title":"Deployment Configuration","text":"<pre><code>env:\n  - name: OAUTH2_PROXY_REDIRECT_URL\n    value: \"https://auth.example.com/oauth2/callback\"\n  - name: OAUTH2_PROXY_UPSTREAMS\n    value: \"http://127.0.0.1:8080\"\n  - name: OAUTH2_PROXY_CLIENT_ID\n    valueFrom:\n      secretKeyRef:\n        name: oauth2-proxy-secret\n        key: client-id\n  - name: OAUTH2_PROXY_CLIENT_SECRET\n    valueFrom:\n      secretKeyRef:\n        name: oauth2-proxy-secret\n        key: client-secret\n  - name: OAUTH2_PROXY_COOKIE_SECRET\n    valueFrom:\n      secretKeyRef:\n        name: oauth2-proxy-secret\n        key: cookie-secret\n</code></pre>"},{"location":"architecture/traffic-flow/#configmap-settings","title":"ConfigMap Settings","text":"<pre><code>provider = \"github\"\nhttp_address = \"0.0.0.0:4180\"\ncookie_domains = [\".example.com\"]\ncookie_secure = true\ncookie_httponly = true\ncookie_samesite = \"lax\"\ncookie_expire = \"168h\"\ncookie_refresh = \"1h\"\nemail_domains = [\"*\"]\nskip_provider_button = false\ncustom_templates_dir = \"/templates\"\nreverse_proxy = true\n</code></pre>"},{"location":"architecture/traffic-flow/#testing-the-flow","title":"Testing the Flow","text":""},{"location":"architecture/traffic-flow/#1-test-unauthenticated-access","title":"1. Test Unauthenticated Access","text":"<pre><code>curl -I https://app.example.com/\n# Should return custom sign-in page HTML\n</code></pre>"},{"location":"architecture/traffic-flow/#2-test-oauth-start-endpoint","title":"2. Test OAuth Start Endpoint","text":"<pre><code>curl -I https://app.example.com/oauth2/start\n# Should redirect to OAuth provider\n</code></pre>"},{"location":"architecture/traffic-flow/#3-test-with-cookie","title":"3. Test with Cookie","text":"<pre><code>curl -I https://app.example.com/ \\\n  -H \"Cookie: _oauth2_proxy=VALID_COOKIE\"\n# Should return 200 OK\n</code></pre>"},{"location":"architecture/traffic-flow/#4-test-logout","title":"4. Test Logout","text":"<pre><code>curl -I \"https://app.example.com/oauth2/sign_out?rd=/\"\n# Should clear cookie and redirect\n</code></pre>"},{"location":"architecture/traffic-flow/#next-steps","title":"Next Steps","text":"<ul> <li>Configure OAuth Providers</li> <li>Customize Sign-in Pages</li> <li>Production Deployment</li> <li>Troubleshooting</li> </ul>"},{"location":"getting-started/quickstart/","title":"Quick Start","text":"<p>Get OAuth2 authentication running on your Kubernetes cluster in under 10 minutes.</p>"},{"location":"getting-started/quickstart/#prerequisites","title":"Prerequisites","text":"<p>Before you begin, ensure you have:</p> <ul> <li> Kubernetes cluster (1.20+) with kubectl access</li> <li> Istio service mesh installed (1.14+)</li> <li> Helm 3 installed</li> <li> A domain with DNS access (e.g., <code>example.com</code>)</li> <li> OAuth application credentials (we'll use GitHub in this guide)</li> </ul>"},{"location":"getting-started/quickstart/#step-1-register-oauth-application","title":"Step 1: Register OAuth Application","text":"GitHubGoogleAzure AD <ol> <li>Go to GitHub Settings \u2192 Developer Settings \u2192 OAuth Apps</li> <li>Click \"New OAuth App\"</li> <li>Fill in the details:<ul> <li>Application name: <code>My App SSO</code></li> <li>Homepage URL: <code>https://example.com</code></li> <li>Authorization callback URL: <code>https://auth.example.com/oauth2/callback</code></li> </ul> </li> <li>Save the Client ID and Client Secret</li> </ol> <ol> <li>Go to Google Cloud Console</li> <li>Create a new project or select existing</li> <li>Navigate to APIs &amp; Services \u2192 Credentials</li> <li>Click Create Credentials \u2192 OAuth client ID</li> <li>Select Web application</li> <li>Add authorized redirect URI: <code>https://auth.example.com/oauth2/callback</code></li> <li>Save the Client ID and Client Secret</li> </ol> <ol> <li>Go to Azure Portal</li> <li>Navigate to Azure Active Directory \u2192 App registrations</li> <li>Click New registration</li> <li>Fill in the details:<ul> <li>Name: <code>My App SSO</code></li> <li>Redirect URI: <code>https://auth.example.com/oauth2/callback</code></li> </ul> </li> <li>Go to Certificates &amp; secrets \u2192 Create new client secret</li> <li>Save the Application (client) ID and Client Secret</li> </ol>"},{"location":"getting-started/quickstart/#step-2-configure-dns","title":"Step 2: Configure DNS","text":"<p>Point a wildcard DNS record to your Istio ingress gateway:</p> <pre><code># Get your Istio ingress gateway IP\nkubectl get svc -n istio-system istio-ingressgateway\n\n# Create DNS A record\n# Name: *.example.com\n# Type: A\n# Value: &lt;INGRESS_IP&gt;\n</code></pre>"},{"location":"getting-started/quickstart/#step-3-install-with-helm","title":"Step 3: Install with Helm","text":"<p>Create a values file with your configuration:</p> my-values.yaml<pre><code># Domain configuration\ndomain: example.com\ncookieDomain: .example.com\n\n# OAuth provider configuration\noauth:\n  provider: github\n  clientID: \"your-client-id\"\n  clientSecret: \"your-client-secret\"\n  # Cookie secret will be auto-generated\n\n# Istio configuration\nistio:\n  enabled: true\n  gateway:\n    create: true\n    name: oauth2-gateway\n    hosts:\n      - \"*.example.com\"\n    tls:\n      mode: SIMPLE\n      credentialName: wildcard-tls  # Your TLS cert secret\n\n# Custom branding\ncustomTemplates:\n  enabled: true\n  brandName: \"My Company SSO\"\n</code></pre> <p>Install the Helm chart:</p> <pre><code>helm install oauth2-sidecar ./helm/oauth2-sidecar \\\n  --values my-values.yaml \\\n  --namespace default \\\n  --create-namespace\n</code></pre> <p>Installation Complete</p> <p>The base OAuth2 infrastructure is now ready! \ud83c\udf89</p>"},{"location":"getting-started/quickstart/#step-4-deploy-example-application","title":"Step 4: Deploy Example Application","text":"<p>Deploy the example app to test the setup:</p> <pre><code>kubectl apply -k k8s/apps/example-app/\n</code></pre> <p>Wait for the pod to be ready:</p> <pre><code>kubectl get pods -l app=example-app -w\n</code></pre>"},{"location":"getting-started/quickstart/#step-5-test-authentication","title":"Step 5: Test Authentication","text":"<p>Open your browser and navigate to:</p> <pre><code>https://example-app.example.com\n</code></pre> <p>You should see:</p> <ol> <li>Sign-in page with your provider button</li> <li>Click the button \u2192 Redirects to OAuth provider</li> <li>Authorize the app \u2192 Redirects back to your app</li> <li>Success! You're now authenticated</li> </ol> <pre><code>sequenceDiagram\n    autonumber\n    participant Browser\n    participant App\n    participant OAuth2Proxy\n    participant GitHub\n\n    Browser-&gt;&gt;App: GET /\n    App-&gt;&gt;OAuth2Proxy: Check auth\n    OAuth2Proxy--&gt;&gt;Browser: 200 Sign-in page\n    Browser-&gt;&gt;OAuth2Proxy: Click GitHub button\n    OAuth2Proxy--&gt;&gt;Browser: 302 Redirect to GitHub\n    Browser-&gt;&gt;GitHub: Authorize\n    GitHub--&gt;&gt;Browser: 302 Callback\n    Browser-&gt;&gt;OAuth2Proxy: GET /oauth2/callback?code=...\n    OAuth2Proxy-&gt;&gt;GitHub: Exchange code\n    GitHub--&gt;&gt;OAuth2Proxy: Access token\n    OAuth2Proxy--&gt;&gt;Browser: 302 Set cookie + redirect\n    Browser-&gt;&gt;App: GET / (with cookie)\n    App-&gt;&gt;OAuth2Proxy: Check auth\n    OAuth2Proxy--&gt;&gt;App: Forward with headers\n    App--&gt;&gt;Browser: 200 App content\n</code></pre>"},{"location":"getting-started/quickstart/#step-6-access-user-information","title":"Step 6: Access User Information","text":"<p>Your application receives user information via HTTP headers:</p> <pre><code># Test with curl (after authenticating in browser)\ncurl -v https://example-app.example.com/headers \\\n  -H \"Cookie: _oauth2_proxy=&lt;your-cookie&gt;\"\n</code></pre> <p>Headers available to your app:</p> <ul> <li><code>X-Auth-Request-User</code>: Username</li> <li><code>X-Auth-Request-Email</code>: Email address</li> <li><code>X-Auth-Request-Preferred-Username</code>: Preferred username</li> <li><code>X-Forwarded-User</code>: User identifier</li> <li><code>X-Forwarded-Email</code>: Email address</li> </ul> <p>Example in your app:</p> Python (Flask)Node.js (Express)Go <pre><code>from flask import Flask, request\n\napp = Flask(__name__)\n\n@app.route('/')\ndef index():\n    user_email = request.headers.get('X-Auth-Request-Email')\n    username = request.headers.get('X-Auth-Request-User')\n    return f'Hello {username} ({user_email})!'\n</code></pre> <pre><code>const express = require('express');\nconst app = express();\n\napp.get('/', (req, res) =&gt; {\n  const userEmail = req.headers['x-auth-request-email'];\n  const username = req.headers['x-auth-request-user'];\n  res.send(`Hello ${username} (${userEmail})!`);\n});\n</code></pre> <pre><code>package main\n\nimport (\n    \"fmt\"\n    \"net/http\"\n)\n\nfunc handler(w http.ResponseWriter, r *http.Request) {\n    email := r.Header.Get(\"X-Auth-Request-Email\")\n    user := r.Header.Get(\"X-Auth-Request-User\")\n    fmt.Fprintf(w, \"Hello %s (%s)!\", user, email)\n}\n\nfunc main() {\n    http.HandleFunc(\"/\", handler)\n    http.ListenAndServe(\":8080\", nil)\n}\n</code></pre>"},{"location":"getting-started/quickstart/#whats-next","title":"What's Next?","text":"<ul> <li>Add authentication to your own app</li> <li>Customize the sign-in page</li> <li>Learn about the architecture</li> <li>Configure advanced options</li> </ul>"},{"location":"getting-started/quickstart/#troubleshooting","title":"Troubleshooting","text":"<p>Not redirecting to OAuth provider?</p> <p>Check that <code>skip_provider_button</code> is set to <code>false</code> in the ConfigMap and the custom templates are mounted.</p> <p>Getting 503 errors?</p> <p>Ensure the VirtualService is routing to the correct service and port (4180).</p> <p>SSO not working across apps?</p> <p>Verify that <code>cookieDomain</code> is set to <code>.example.com</code> (with leading dot) and all apps use the same domain.</p> <p>For more help, see the Troubleshooting Guide.</p>"},{"location":"providers/azure-ad/","title":"Azure AD OAuth2 Setup","text":"<p>This guide shows how to configure Azure Active Directory as the OAuth2 provider for the OAuth2 Sidecar.</p>"},{"location":"providers/azure-ad/#1-register-an-application-in-azure-ad","title":"1. Register an Application in Azure AD","text":"<ol> <li>Go to Azure Portal \u2192 Azure Active Directory \u2192 App registrations</li> <li>Click New registration</li> <li>Set:</li> <li>Name: <code>OAuth2 Sidecar</code></li> <li>Supported account types: Choose based on your scenario</li> <li>Redirect URI: <code>https://my-app.example.com/oauth2/callback</code></li> <li>Click Register</li> </ol>"},{"location":"providers/azure-ad/#2-configure-api-permissions","title":"2. Configure API Permissions","text":"<ol> <li>In your app registration, go to API permissions</li> <li>Ensure <code>openid</code> and <code>profile</code> scopes are included</li> <li>Add additional scopes if needed (e.g. <code>email</code>)</li> </ol>"},{"location":"providers/azure-ad/#3-collect-required-values","title":"3. Collect Required Values","text":"<p>From your app registration: - Application (client) ID - Directory (tenant) ID - Client Secret (create one under Certificates &amp; secrets)</p>"},{"location":"providers/azure-ad/#4-configure-the-helm-chart","title":"4. Configure the Helm Chart","text":"<p>In your <code>values.yaml</code>:</p> <pre><code>domain: example.com\ncookieDomain: .example.com\n\noauth:\n  provider: azure\n  clientID: \"YOUR_CLIENT_ID\"\n  clientSecret: \"YOUR_CLIENT_SECRET\"\n  cookieSecret: \"$(openssl rand -base64 32)\"\n\n  azure:\n    tenant: \"YOUR_TENANT_ID\"\n    resource: \"api://YOUR_APP_ID_URI\"  # Optional: custom resource/audience\n</code></pre> <p>Or using a pre-created secret:</p> <pre><code>kubectl create secret generic oauth2-proxy-secret \\\n  --from-literal=client-id=YOUR_CLIENT_ID \\\n  --from-literal=client-secret=YOUR_CLIENT_SECRET \\\n  --from-literal=cookie-secret=$(openssl rand -base64 32)\n</code></pre> <pre><code>oauth:\n  provider: azure\n  existingSecret: oauth2-proxy-secret\n</code></pre>"},{"location":"providers/azure-ad/#5-test-the-flow","title":"5. Test the Flow","text":"<ol> <li>Deploy the Helm chart with your configuration</li> <li>Deploy an example app (e.g. <code>examples/simple-app</code>)</li> <li>Open <code>https://simple-app.example.com</code></li> <li>You should be redirected to Azure AD to sign in</li> <li>After successful login, you will be redirected back to your app</li> </ol>"},{"location":"providers/github/","title":"GitHub OAuth2 Setup","text":"<p>This guide shows how to configure GitHub as the OAuth2 provider for the OAuth2 Sidecar.</p>"},{"location":"providers/github/#1-create-a-github-oauth-app","title":"1. Create a GitHub OAuth App","text":"<ol> <li>Go to Settings \u2192 Developer settings \u2192 OAuth Apps</li> <li>Click New OAuth App</li> <li>Set the following values:</li> <li>Application name: <code>OAuth2 Sidecar</code></li> <li>Homepage URL: <code>https://your-domain.example.com</code></li> <li>Authorization callback URL: <code>https://my-app.example.com/oauth2/callback</code></li> <li>Click Register application</li> </ol> <p>Copy the following values: - Client ID - Client Secret</p>"},{"location":"providers/github/#2-configure-the-helm-chart","title":"2. Configure the Helm Chart","text":"<p>In your <code>values.yaml</code> or via <code>--set</code> flags:</p> <pre><code>domain: example.com\ncookieDomain: .example.com\n\noauth:\n  provider: github\n  clientID: \"YOUR_CLIENT_ID\"\n  clientSecret: \"YOUR_CLIENT_SECRET\"\n  cookieSecret: \"$(openssl rand -base64 32)\"\n\n  github:\n    org: \"\"   # Optional: restrict to org\n    team: \"\"  # Optional: restrict to team\n</code></pre> <p>Or using the secret-based approach:</p> <pre><code>kubectl create secret generic oauth2-proxy-secret \\\n  --from-literal=client-id=YOUR_CLIENT_ID \\\n  --from-literal=client-secret=YOUR_CLIENT_SECRET \\\n  --from-literal=cookie-secret=$(openssl rand -base64 32)\n</code></pre> <p>And in <code>values.yaml</code>:</p> <pre><code>oauth:\n  provider: github\n  existingSecret: oauth2-proxy-secret\n</code></pre>"},{"location":"providers/github/#3-restrict-access-by-organization-or-team","title":"3. Restrict Access by Organization or Team","text":"<p>To restrict access to a single GitHub organization:</p> <pre><code>oauth:\n  provider: github\n  github:\n    org: \"my-org\"\n</code></pre> <p>To restrict access to a specific team (requires <code>org</code>):</p> <pre><code>oauth:\n  provider: github\n  github:\n    org: \"my-org\"\n    team: \"my-team\"\n</code></pre>"},{"location":"providers/github/#4-test-the-flow","title":"4. Test the Flow","text":"<ol> <li>Deploy the Helm chart with your configuration</li> <li>Deploy an example app (e.g. <code>examples/simple-app</code>)</li> <li>Open <code>https://simple-app.example.com</code></li> <li>You should be redirected to GitHub to sign in</li> <li>After successful login, you will be redirected back to your app</li> </ol>"},{"location":"providers/google/","title":"Google OAuth2 Setup","text":"<p>This guide shows how to configure Google as the OAuth2 provider for the OAuth2 Sidecar.</p>"},{"location":"providers/google/#1-create-oauth-credentials-in-google-cloud","title":"1. Create OAuth Credentials in Google Cloud","text":"<ol> <li>Go to Google Cloud Console \u2192 APIs &amp; Services \u2192 Credentials</li> <li>Click Create Credentials \u2192 OAuth client ID</li> <li>Choose Web application</li> <li>Set Authorized redirect URIs to:</li> <li><code>https://my-app.example.com/oauth2/callback</code></li> <li>Click Create</li> </ol> <p>Copy the following values: - Client ID - Client Secret</p>"},{"location":"providers/google/#2-configure-the-helm-chart","title":"2. Configure the Helm Chart","text":"<p>In your <code>values.yaml</code>:</p> <pre><code>domain: example.com\ncookieDomain: .example.com\n\noauth:\n  provider: google\n  clientID: \"YOUR_CLIENT_ID.apps.googleusercontent.com\"\n  clientSecret: \"YOUR_CLIENT_SECRET\"\n  cookieSecret: \"$(openssl rand -base64 32)\"\n\n  google:\n    hostedDomain: \"mycompany.com\"  # Optional: restrict to your Google Workspace domain\n</code></pre> <p>Or using a pre-created secret:</p> <pre><code>kubectl create secret generic oauth2-proxy-secret \\\n  --from-literal=client-id=YOUR_CLIENT_ID.apps.googleusercontent.com \\\n  --from-literal=client-secret=YOUR_CLIENT_SECRET \\\n  --from-literal=cookie-secret=$(openssl rand -base64 32)\n</code></pre> <pre><code>oauth:\n  provider: google\n  existingSecret: oauth2-proxy-secret\n</code></pre>"},{"location":"providers/google/#3-restrict-to-a-google-workspace-domain","title":"3. Restrict to a Google Workspace Domain","text":"<p>To allow only users from a specific Google Workspace domain:</p> <pre><code>oauth:\n  provider: google\n  google:\n    hostedDomain: \"mycompany.com\"\n</code></pre>"},{"location":"providers/google/#4-test-the-flow","title":"4. Test the Flow","text":"<ol> <li>Deploy the Helm chart with your configuration</li> <li>Deploy an example app (e.g. <code>examples/simple-app</code>)</li> <li>Open <code>https://simple-app.example.com</code></li> <li>You should be redirected to Google to sign in</li> <li>After successful login, you will be redirected back to your app</li> </ol>"},{"location":"providers/oidc/","title":"Generic OIDC Setup","text":"<p>This guide shows how to configure a generic OpenID Connect (OIDC) provider for the OAuth2 Sidecar.</p>"},{"location":"providers/oidc/#1-create-a-client-in-your-oidc-provider","title":"1. Create a Client in Your OIDC Provider","text":"<p>Steps vary by provider (Keycloak, Auth0, Okta, etc.), but generally:</p> <ol> <li>Create a new application/client</li> <li>Set the redirect URI to:</li> <li><code>https://my-app.example.com/oauth2/callback</code></li> <li>Enable standard OIDC scopes: <code>openid</code>, <code>profile</code>, <code>email</code></li> </ol> <p>Collect the following values: - Client ID - Client Secret - Issuer URL (e.g. <code>https://auth.example.com/realms/myrealm</code>)</p>"},{"location":"providers/oidc/#2-configure-the-helm-chart","title":"2. Configure the Helm Chart","text":"<p>In your <code>values.yaml</code>:</p> <pre><code>domain: example.com\ncookieDomain: .example.com\n\noauth:\n  provider: oidc\n  clientID: \"YOUR_CLIENT_ID\"\n  clientSecret: \"YOUR_CLIENT_SECRET\"\n  cookieSecret: \"$(openssl rand -base64 32)\"\n\n  oidc:\n    issuerURL: \"https://auth.example.com/realms/myrealm\"\n    extraScopes:\n      - \"profile\"\n      - \"email\"\n</code></pre> <p>Or using a pre-created secret:</p> <pre><code>kubectl create secret generic oauth2-proxy-secret \\\n  --from-literal=client-id=YOUR_CLIENT_ID \\\n  --from-literal=client-secret=YOUR_CLIENT_SECRET \\\n  --from-literal=cookie-secret=$(openssl rand -base64 32)\n</code></pre> <pre><code>oauth:\n  provider: oidc\n  existingSecret: oauth2-proxy-secret\n\n  oidc:\n    issuerURL: \"https://auth.example.com/realms/myrealm\"\n    extraScopes:\n      - \"profile\"\n      - \"email\"\n</code></pre>"},{"location":"providers/oidc/#3-test-the-flow","title":"3. Test the Flow","text":"<ol> <li>Deploy the Helm chart with your configuration</li> <li>Deploy an example app (e.g. <code>examples/simple-app</code>)</li> <li>Open <code>https://simple-app.example.com</code></li> <li>You should be redirected to your OIDC provider to sign in</li> <li>After successful login, you will be redirected back to your app</li> </ol>"}]}